# Copyright 2016 Maxime Herpin, Jake Dube
#
# ##### BEGIN GPL LICENSE BLOCK ######
# This file is part of Modular Tree.
#
# Modular Tree is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# Modular Tree is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with Modular Tree.  If not, see <http://www.gnu.org/licenses/>.
# ##### END GPL LICENSE BLOCK #####

from mathutils import Vector, Matrix
from random import random, randint
from math import pi, radians

import bpy

from .clock import Clock
from .uv_tools import rotate, add_seams
from .particle_configurator import create_system
from .material_tools import build_bark_material


class Module:
    """This is used to represent a branch

    Methods:
        __init__ - Initialises the variables
        __repr__ - How the Module is represented
    """

    def __init__(self, entree, sortie, verts, faces):
        """Initialises the variables

        Args:
            entree - (list of int) The indexes of the entry vertices
            sortie - (list of int) The indexes of the exit vertices
            verts - (list of vector) The vertices of the Module
            faces - (list of (int, int, int, int)) The faces of the Module
        """
        self.entree = entree
        self.sortie = sortie
        self.verts = verts
        self.faces = faces

    def __repr__(self):
        return 'entry vertices:{} , number of splits:{}'.format(len(self.entree), len(self.sortie))


end_cap = Module(
    # entree
    [0, 1, 2, 3, 4, 5, 6, 7],
    # sortie
    [],
    # verts
    [(0.0, 1.0, 0.02), (-0.71, 0.71, 0.02), (-1.0, -0.0, 0.04), (-0.71, -0.71, 0.04), (0.0, -1.0, 0.02),
     (0.71, -0.71, 0.02), (1.0, 0.0, 0.04), (0.71, 0.71, 0.04), (0.0, 0.98, 0.14), (-0.69, 0.69, 0.14),
     (-0.98, -0.0, 0.21), (-0.69, -0.69, 0.21), (0.0, -0.98, 0.14), (0.69, -0.69, 0.14), (0.98, 0.0, 0.21),
     (0.69, 0.69, 0.21), (0.0, 0.88, 0.26), (-0.62, 0.62, 0.26), (-0.88, -0.0, 0.33), (-0.62, -0.62, 0.33),
     (0.0, -0.88, 0.26), (0.62, -0.62, 0.26), (0.88, 0.0, 0.33), (0.62, 0.62, 0.33), (0.0, 0.74, 0.32),
     (-0.52, 0.52, 0.32), (-0.74, -0.0, 0.41), (-0.52, -0.52, 0.41), (0.0, -0.74, 0.32), (0.52, -0.52, 0.32),
     (0.74, 0.0, 0.41), (0.52, 0.52, 0.41), (0.0, 0.33, 0.59), (-0.23, 0.23, 0.59), (-0.26, 0.02, 0.67),
     (-0.16, -0.2, 0.67), (0.0, -0.33, 0.59), (0.23, -0.23, 0.59), (0.26, -0.02, 0.67), (0.16, 0.2, 0.67)],
    # faces
    [(7, 15, 14, 6), (5, 13, 12, 4), (3, 11, 10, 2), (0, 8, 15, 7), (6, 14, 13, 5), (4, 12, 11, 3), (2, 10, 9, 1),
     (15, 8, 16, 23), (13, 14, 22, 21), (11, 12, 20, 19), (9, 10, 18, 17), (14, 15, 23, 22), (12, 13, 21, 20),
     (10, 11, 19, 18), (8, 9, 17, 16), (18, 19, 27, 26), (16, 17, 25, 24), (23, 16, 24, 31), (21, 22, 30, 29),
     (19, 20, 28, 27), (17, 18, 26, 25), (22, 23, 31, 30), (20, 21, 29, 28), (30, 31, 39, 38), (28, 29, 37, 36),
     (26, 27, 35, 34), (24, 25, 33, 32), (31, 24, 32, 39), (29, 30, 38, 37), (27, 28, 36, 35), (35, 38, 39, 34),
     (39, 32, 33, 34), (35, 36, 37, 38), (1, 9, 8, 0), (25, 26, 34, 33)])


class Split:
    """This is used to represent a branch split, each vertex position is an interpolation of two vectors, which allows more variation

    Methods:
        __init__ - Initialises the variables
    """

    def __init__(self, entree, sortie, verts1, verts2, faces, seams):
        """Initialises the variables

        Args:
            entree - (list of int) The indexes of the entry vertices
            sortie - ((list of int, list of int)) The indexes of the exit vertices
            verts1 - (list of vector) The vertices of the split in one form
            verts2 - (list of vector) The vertices of the split in the second form
            faces - (list of (int, int, int, int)) The faces of the Split
            seams - (list of (int, int)) The seams of the Split
        """
        self.entree = entree
        self.sortie = sortie
        self.verts1 = verts1
        self.verts2 = verts2
        self.faces = faces
        self.Seams = seams


def interpolate(verts1, verts2, t):
    """Linearly interpolates the vertices positions

    Args:
        verts1 - (list of vector) The first positions
        verts2 - (list of vector) The second positions
        t - (float) The interpolation factor

    Returns:
        (list of vector) The interpolated positions
    """
    return [Vector(verts1[i]) * (1 - t) + Vector(verts2[i]) * t for i in range(len(verts1))]


S2 = Split(
    # entree
    [0, 1, 2, 3, 4, 5, 6, 7],
    # sortie
    ([8, 9, 10, 11, 12, 13, 14, 15], [16, 17, 18, 19, 20, 21, 22, 23]),
    # verts1
    [(-0.0, 1.0, -0.01), (-0.71, 0.71, -0.01), (-1.0, -0.0, -0.01), (-0.71, -0.71, -0.01), (0.0, -1.0, -0.01),
     (0.71, -0.71, -0.01), (1.0, -0.0, -0.02), (0.71, 0.71, -0.02), (-0.98, 0.89, 1.84), (-1.49, 0.74, 1.62),
     (-1.78, 0.24, 1.53), (-1.67, -0.33, 1.64), (-1.23, -0.64, 1.87), (-0.73, -0.51, 2.09), (-0.46, 0.0, 2.18),
     (-0.56, 0.59, 2.07), (0.72, 1.02, 1.8), (1.3, 0.65, 1.8), (1.29, -0.07, 1.93), (0.81, -0.6, 2.07),
     (0.12, -0.57, 2.13), (-0.37, -0.06, 2.17), (-0.46, 0.62, 2.06), (0.03, 1.05, 1.88), (-1.19, -0.63, 0.6),
     (-1.42, -0.01, 0.52), (-0.71, -1.0, 0.98), (-0.39, -0.91, 1.36), (0.63, -0.72, 1.11), (-0.2, -0.73, 1.49),
     (0.85, 0.64, 0.64), (1.12, 0.01, 0.68), (0.28, 0.97, 0.69), (-0.72, 0.91, 0.89), (-1.21, 0.7, 0.6),
     (-0.36, 0.92, 1.36), (-0.43, -1.0, 0.68), (0.13, -1.05, 0.69), (-.42, 0.09, 0.90), (0.13, 0.16, 0.97)],
    # verts2
    [(-0.0, 1.0, 0.0), (-0.71, 0.71, 0.0), (-1.0, -0.0, 0.0), (-0.71, -0.71, 0.0), (0.0, -1.0, 0.0),
     (0.71, -0.71, 0.0), (1.0, -0.0, -0.0), (0.71, 0.71, -0.01), (-1.34, 0.76, 0.99), (-1.43, 0.53, 0.47),
     (-1.47, -0.01, 0.25), (-1.43, -0.56, 0.48), (-1.33, -0.79, 1.0), (-1.24, -0.58, 1.51), (-1.21, -0.03, 1.72),
     (-1.26, 0.57, 1.53), (0.73, 1.02, 1.08), (1.08, 0.65, 0.61), (1.18, -0.07, 0.7), (1.0, -0.6, 1.16),
     (0.63, -0.57, 1.75), (0.35, -0.06, 2.16), (0.21, 0.62, 2.16), (0.38, 1.05, 1.67), (-0.94, -0.63, 0.26),
     (-1.12, -0.01, 0.09), (-0.8, -1.0, 0.78), (-0.59, -0.81, 1.45), (0.75, -0.72, 0.94), (-0.07, -0.51, 1.66),
     (0.84, 0.64, 0.42), (1.12, 0.01, 0.39), (0.31, 0.97, 0.63), (-0.79, 0.91, 0.69), (-0.96, 0.7, 0.25),
     (-0.38, 0.92, 1.37), (-0.43, -1.0, 0.69), (0.13, -1.05, 0.7), (-.98, 0, 0.16), (0.85, 0.16, 0.49)],
    # faces
    [(25, 24, 11, 10), (15, 14, 21, 22), (2, 3, 24, 25), (12, 26, 27, 13), (12, 11, 24, 26), (20, 29, 28, 19),
     (20, 21, 14, 29), (14, 13, 27, 29), (31, 30, 17, 18), (30, 32, 16, 17), (7, 0, 32, 30), (6, 7, 30, 31),
     (18, 19, 28, 31), (8, 33, 34, 9), (9, 34, 25, 10), (1, 2, 25, 34), (15, 35, 33, 8), (23, 35, 15, 22),
     (35, 23, 16, 32), (33, 35, 32, 0), (34, 33, 0, 1), (5, 6, 31, 28), (36, 26, 24, 3), (37, 36, 3, 4),
     (4, 5, 28, 37), (27, 26, 36, 37), (28, 29, 27, 37)],
    # seams
    [(4, 37), (36, 37), (26, 36), (12, 26), (28, 37), (19, 28), (14, 21)])

S1 = Split(
    # entree
    [0, 1, 2, 3, 4, 5, 6, 7],
    # sortie
    ([8, 9, 10, 11, 12, 13, 14, 15], [16, 17, 18, 19, 20, 21, 22, 23]),
    # verts1
    [(0.0, 1.0, 0.0), (-0.71, 0.71, 0.0), (-1.0, -0.0, 0.0), (-0.71, -0.71, 0.0), (0.0, -1.0, 0.0),
     (0.71, -0.71, 0.0), (1.0, 0.0, 0.0), (0.71, 0.71, 0.0), (-0.0, -0.17, 1.01), (-0.42, -0.29, 0.88),
     (-0.59, -0.58, 0.58), (-0.42, -0.88, 0.29), (0.0, -1.0, 0.16), (0.42, -0.88, 0.29), (0.59, -0.58, 0.58),
     (0.42, -0.29, 0.88), (-0.0, 1.0, 0.17), (-0.43, 0.88, 0.29), (-0.61, 0.57, 0.6), (-0.43, 0.26, 0.9),
     (0.0, 0.13, 1.02), (0.43, 0.26, 0.9), (0.61, 0.57, 0.6), (0.43, 0.88, 0.29), (0.85, 0.44, 0.37),
     (0.91, -0.38, 0.42), (0.79, 0.04, 0.65), (0.0, -0.02, 1.02), (0.43, -0.02, 0.89), (-0.43, -0.02, 0.89),
     (-0.91, -0.38, 0.41), (-0.82, 0.04, 0.65), (-0.91, 0.44, 0.37), (0, -1, 1), (0, 1, 1)],
    # verts2
    [(0.0, 1.0, 0.0), (-0.71, 0.71, 0.0), (-1.0, -0.0, 0.0), (-0.71, -0.71, 0.0), (0.0, -1.0, 0.0),
     (0.71, -0.71, 0.0), (1.0, 0.0, 0.0), (0.71, 0.71, 0.0), (-0.0, -0.17, 1.01), (-0.42, -0.29, 0.88),
     (-0.59, -0.58, 0.58), (-0.42, -0.88, 0.29), (0.0, -1.0, 0.16), (0.42, -0.88, 0.29), (0.59, -0.58, 0.58),
     (0.42, -0.29, 0.88), (-0.0, 1.0, 0.17), (-0.43, 0.88, 0.29), (-0.61, 0.57, 0.6), (-0.43, 0.26, 0.9),
     (0.0, 0.13, 1.02), (0.43, 0.26, 0.9), (0.61, 0.57, 0.6), (0.43, 0.88, 0.29), (0.85, 0.44, 0.37),
     (0.91, -0.38, 0.42), (0.79, 0.04, 0.65), (0.0, -0.02, 1.02), (0.43, -0.02, 0.89), (-0.43, -0.02, 0.89),
     (-0.91, -0.38, 0.41), (-0.82, 0.04, 0.65), (-0.91, 0.44, 0.37), (0, -1, 1), (0, 1, 1)],
    # faces
    [(4, 5, 13, 12), (3, 4, 12, 11), (7, 0, 16, 23), (0, 1, 17, 16), (27, 28, 21, 20), (29, 27, 20, 19),
     (25, 13, 5, 6), (6, 7, 23, 24), (22, 26, 24, 23), (14, 13, 25, 26), (24, 26, 25, 6), (9, 8, 27, 29),
     (8, 15, 28, 27), (22, 21, 28, 26), (14, 26, 28, 15), (30, 31, 32, 2), (2, 32, 17, 1), (2, 3, 11, 30),
     (10, 31, 30, 11), (17, 32, 31, 18), (10, 9, 29, 31), (18, 31, 29, 19)],
    # seams
    [(4, 37), (36, 37), (26, 36), (12, 26), (28, 37), (19, 28), (14, 21)])


S3 = Split(
    [0, 1, 2, 3, 4, 5, 6, 7],
    ([8, 9, 10, 11, 12, 13, 14, 15], [16, 17, 18, 19, 20, 21, 22, 23]),
    [(0.0, 1.0, 0.0), (-0.71, 0.71, 0.0), (-1.01, -0.0, -0.0), (-0.71, -0.71, 0.0), (0.0, -1.0, 0.0),
     (0.71, -0.71, -0.0), (1.01, 0.0, -0.02), (0.71, 0.71, -0.0), (-1.15, 0.76, 2.44), (-1.69, 0.54, 2.4),
     (-1.91, -0.0, 2.38), (-1.69, -0.54, 2.4), (-1.15, -0.76, 2.44), (-0.56, -0.54, 2.51), (-0.22, -0.0, 2.67),
     (-0.56, 0.54, 2.51), (1.23, 0.8, 2.56), (0.67, 0.57, 2.73), (0.41, -0.0, 2.79), (0.67, -0.57, 2.73),
     (1.23, -0.8, 2.56), (1.78, -0.56, 2.39), (2.06, -0.0, 2.34), (1.78, 0.56, 2.39), (0.95, 0.73, 1.87),
     (0.53, 0.55, 2.21), (0.23, -0.0, 2.43), (0.53, -0.55, 2.21), (0.94, -0.73, 1.87), (1.31, -0.5, 1.47),
     (1.6, -0.0, 1.5), (1.36, 0.5, 1.49), (-0.85, 0.71, 1.75), (-1.33, 0.5, 1.53), (-1.63, -0.0, 1.6),
     (-1.33, -0.5, 1.53), (-0.85, -0.71, 1.75), (-0.31, -0.53, 2.09), (-0.01, -0.0, 2.45), (-0.31, 0.53, 2.09),
     (0.04, -0.68, 1.3), (0.09, -0.62, 1.96), (0.06, -0.0, 2.4), (0.09, 0.62, 1.96), (0.04, 0.68, 1.3),
     (-0.37, -0.78, 0.67), (-0.0, -0.88, 0.68), (0.41, -0.79, 0.66), (-0.0, 0.85, 0.68), (-0.48, 0.73, 0.76),
     (0.6, 0.74, 0.76), (0.71, -0.71, -0.0), (0.71, 0.71, -0.0), (1.25, -0.0, 0.99), (0.95, -0.43, 0.93),
     (0.95, 0.43, 0.95), (1.11, -0.0, 0.59), (0.85, -0.28, 0.32), (0.83, 0.26, 0.31), (-1.26, -0.0, 1.1),
     (-0.84, 0.44, 1.04), (-0.84, -0.44, 1.04), (-1.03, -0.0, 0.7), (-0.83, 0.33, 0.42), (-0.82, -0.39, 0.43),
     (-0.0, -0.97, 0.32), (0.54, -0.75, 0.32), (-0.54, -0.75, 0.34), (0.65, 0.73, 0.34), (0.0, 0.96, 0.31),
     (-0.6, 0.72, 0.38), (-1.38, -0.02, 3.41), (-1.16, -0.02, 2.53), (1.55, -0.02, 3.36), (1.26, -0.02, 2.5),
     (-0.22, 0.0, 0.88), (0.29, 0.0, 0.86)],
    [(0.0, 1.0, 0.0), (-0.71, 0.71, 0.0), (-1.01, -0.0, -0.01), (-0.71, -0.71, 0.0), (0.0, -1.0, 0.0),
     (0.71, -0.71, -0.0), (1.0, 0.0, -0.04), (0.71, 0.71, -0.0), (-0.97, 0.74, 2.5), (-1.38, 0.53, 2.25),
     (-1.55, -0.0, 2.15), (-1.38, -0.53, 2.25), (-0.97, -0.74, 2.5), (-0.51, -0.53, 2.78), (-0.26, -0.0, 3.01),
     (-0.51, 0.53, 2.78), (1.42, 0.78, 2.33), (1.13, 0.56, 2.71), (1.0, -0.0, 2.89), (1.13, -0.56, 2.71),
     (1.42, -0.78, 2.33), (1.7, -0.55, 1.97), (1.86, -0.0, 1.81), (1.7, 0.55, 1.97), (0.99, 0.77, 1.87),
     (0.69, 0.59, 2.34), (0.52, -0.0, 2.77), (0.69, -0.59, 2.34), (0.99, -0.77, 1.87), (1.33, -0.52, 1.45),
     (1.58, -0.0, 1.41), (1.37, 0.53, 1.46), (-0.76, 0.79, 1.87), (-1.22, 0.54, 1.55), (-1.46, -0.0, 1.6),
     (-1.22, -0.54, 1.55), (-0.76, -0.79, 1.87), (-0.24, -0.58, 2.35), (0.09, -0.0, 2.82), (-0.24, 0.58, 2.35),
     (0.05, -0.7, 1.28), (0.12, -0.72, 2.1), (0.19, -0.0, 2.75), (0.12, 0.72, 2.1), (0.05, 0.7, 1.28),
     (-0.37, -0.79, 0.65), (0.0, -0.88, 0.68), (0.4, -0.79, 0.65), (0.0, 0.85, 0.68), (-0.47, 0.75, 0.74),
     (0.58, 0.76, 0.74), (0.71, -0.71, -0.0), (0.71, 0.71, -0.0), (1.34, -0.0, 1.01), (0.99, -0.46, 0.91),
     (1.02, 0.47, 0.95), (1.23, -0.0, 0.58), (0.86, -0.29, 0.29), (0.84, 0.27, 0.29), (-1.18, -0.0, 1.05),
     (-0.82, 0.48, 0.99), (-0.82, -0.48, 0.99), (-0.99, -0.0, 0.66), (-0.82, 0.34, 0.39), (-0.81, -0.4, 0.41),
     (-0.0, -0.97, 0.32), (0.54, -0.75, 0.32), (-0.54, -0.75, 0.33), (0.64, 0.73, 0.34), (0.0, 0.96, 0.31),
     (-0.6, 0.72, 0.37), (-1.41, -0.02, 3.36), (-0.97, -0.02, 2.61), (2.2, -0.02, 2.78), (1.54, -0.02, 2.31),
     (-0.44, 0.0, 0.75), (0.66, 0.0, 0.47)],
    [(22, 30, 31, 23), (20, 28, 29, 21), (18, 26, 27, 19), (16, 24, 25, 17), (23, 31, 24, 16), (21, 29, 30, 22),
     (19, 27, 28, 20), (17, 25, 26, 18), (13, 37, 38, 14), (11, 35, 36, 12), (9, 33, 34, 10), (14, 38, 39, 15),
     (12, 36, 37, 13), (10, 34, 35, 11), (8, 32, 33, 9), (15, 39, 32, 8), (44, 32, 39, 43), (43, 39, 38, 42),
     (42, 38, 37, 41), (41, 37, 36, 40), (27, 41, 40, 28), (26, 42, 41, 27), (25, 43, 42, 26), (24, 44, 43, 25),
     (65, 66, 47, 46), (67, 65, 46, 45), (40, 46, 47, 28), (36, 45, 46, 40), (68, 69, 48, 50), (69, 70, 49, 48),
     (44, 48, 49, 32), (24, 50, 48, 44), (31, 30, 53, 55), (30, 29, 54, 53), (55, 53, 56, 58), (53, 54, 57, 56),
     (31, 55, 50, 24), (29, 28, 47, 54), (35, 34, 59, 61), (34, 33, 60, 59), (61, 59, 62, 64), (59, 60, 63, 62),
     (35, 61, 45, 36), (3, 4, 65, 67), (4, 51, 66, 65), (0, 1, 70, 69), (7, 0, 69, 68), (64, 67, 45, 61),
     (33, 32, 49, 60), (70, 63, 60, 49), (58, 68, 50, 55), (66, 57, 54, 47), (62, 63, 2, 64), (3, 67, 64, 2),
     (2, 63, 70, 1), (66, 51, 6, 57), (52, 68, 58, 6), (56, 57, 6, 58)],
    [(26, 18), (14, 38), (38, 42), (26, 42), (41, 40), (42, 41), (65, 4), (40, 46), (46, 65)])

S4 = Split(
    [0, 1, 2, 3, 4, 5, 6, 7],
    ([8, 9, 10, 11, 12, 13, 14, 15], [16, 17, 18, 19, 20, 21, 22, 23]),
    [(0.0, 1.0, 0.0), (-0.71, 0.71, 0.0), (-1.0, -0.0, 0.0), (-0.71, -0.71, 0.0), (0.0, -1.0, 0.0), (0.71, -0.71, 0.0),
     (1.0, 0.0, 0.0), (0.71, 0.71, 0.0), (-1.41, 0.48, 2.6), (-1.68, 0.18, 2.56), (-1.66, -0.22, 2.56),
     (-1.36, -0.5, 2.58), (-0.99, -0.48, 2.63), (-0.7, -0.18, 2.71), (-0.69, 0.22, 2.73), (-1.02, 0.5, 2.64),
     (1.11, 0.88, 2.69), (0.37, 0.91, 2.73), (-0.16, 0.37, 2.76), (-0.09, -0.37, 2.8), (0.42, -0.88, 2.83),
     (1.14, -0.87, 2.79), (1.64, -0.35, 2.74), (1.62, 0.37, 2.7), (-0.38, -0.72, 2.43), (-0.49, 0.75, 2.25),
     (0.82, 0.89, 1.78), (0.03, 1.0, 2.04), (0.0, 0.92, 0.63), (-0.71, 0.71, 0.67), (-1.0, -0.0, 0.67),
     (-0.71, -0.71, 0.67), (0.01, -0.99, 0.69), (0.71, -0.71, 0.67), (0.95, 0.07, 0.69), (0.71, 0.71, 0.67),
     (0.23, -0.86, 2.41), (0.94, -0.88, 2.21), (1.23, -0.41, 1.84), (-0.45, 0.28, 2.61), (-0.41, -0.29, 2.6),
     (-0.59, -0.51, 2.51), (-0.67, 0.63, 2.43), (-1.3, 0.53, 2.14), (-1.53, 0.21, 2.06), (-1.5, -0.38, 2.03),
     (-1.23, -0.68, 2.16), (-0.86, -0.69, 2.37), (-1.12, 0.61, 2.29), (1.39, 0.24, 1.83), (0.89, -0.54, 1.21),
     (1.08, 0.15, 1.14), (0.57, 0.76, 1.18), (-0.64, -0.86, 1.65), (-0.2, -0.98, 1.81), (-0.65, -0.83, 1.2),
     (0.4, -0.9, 1.45), (-0.27, -0.96, 1.22), (-1.15, -0.26, 1.37), (-1.0, -0.7, 1.3), (-1.06, -0.14, 1.0),
     (-0.92, -0.6, 0.95), (-1.0, 0.58, 1.55), (-0.57, 0.8, 1.71), (-1.29, 0.25, 1.47), (-0.95, 0.42, 1.1),
     (-0.46, 0.84, 0.99), (-0.68, 0.7, 1.25), (0.16, 1.0, 1.48), (-0.27, 0.92, 1.38), (0.04, 0.96, 1.04),
     (-1.31, 0.01, 3.35), (-1.12, 0.01, 2.5), (0.83, 0.01, 3.56), (0.76, 0.01, 2.66), (-0.19, 0.0, 0.85),
     (0.07, 0.0, 0.9)],
    [(0.0, 1.0, 0.0), (-0.71, 0.71, 0.0), (-1.0, -0.0, 0.0), (-0.71, -0.71, 0.0), (0.0, -1.0, 0.0),
     (0.71, -0.71, 0.0), (1.0, -0.0, 0.0), (0.71, 0.71, 0.0), (-1.29, 0.48, 2.19), (-1.45, 0.18, 2.04),
     (-1.44, -0.22, 2.05), (-1.25, -0.5, 2.2), (-1.01, -0.48, 2.4), (-0.81, -0.18, 2.56), (-0.81, 0.22, 2.59),
     (-1.05, 0.5, 2.41), (0.86, 0.88, 2.22), (0.23, 0.91, 2.48), (-0.26, 0.37, 2.7), (-0.18, -0.37, 2.72),
     (0.3, -0.88, 2.55), (0.92, -0.87, 2.3), (1.34, -0.35, 2.1), (1.31, 0.37, 2.07), (-0.48, -0.72, 2.39),
     (-0.57, 0.75, 2.21), (0.54, 0.89, 1.54), (-0.17, 1.0, 1.96), (0.0, 0.92, 0.63), (-0.71, 0.71, 0.67),
     (-1.0, -0.0, 0.67), (-0.71, -0.71, 0.67), (0.01, -0.99, 0.69), (0.71, -0.71, 0.67), (0.95, 0.07, 0.69),
     (0.71, 0.71, 0.67), (0.06, -0.86, 2.25), (0.67, -0.88, 1.88), (0.94, -0.41, 1.5), (-0.58, 0.28, 2.54),
     (-0.53, -0.29, 2.54), (-0.69, -0.51, 2.44), (-0.75, 0.63, 2.35), (-1.14, 0.53, 1.89), (-1.19, 0.21, 1.66),
     (-1.26, -0.38, 1.72), (-1.09, -0.68, 1.93), (-0.87, -0.69, 2.24), (-1.06, 0.61, 2.09), (1.06, 0.24, 1.44),
     (0.78, -0.54, 1.13), (0.94, 0.15, 1.02), (0.46, 0.76, 1.11), (-0.62, -0.86, 1.63), (-0.32, -0.98, 1.78),
     (-0.65, -0.83, 1.2), (0.29, -0.9, 1.38), (-0.28, -0.96, 1.22), (-0.95, -0.26, 1.23), (-0.97, -0.7, 1.29),
     (-0.99, -0.14, 0.97), (-0.92, -0.6, 0.95), (-0.78, 0.58, 1.42), (-0.61, 0.8, 1.7), (-0.93, 0.25, 1.22),
     (-0.83, 0.42, 1.04), (-0.46, 0.84, 0.99), (-0.63, 0.7, 1.24), (0.06, 1.0, 1.44), (-0.34, 0.92, 1.37),
     (0.03, 0.96, 1.04), (-1.65, 0.01, 2.93), (-1.16, 0.01, 2.4), (1.06, 0.01, 3.35), (0.74, 0.01, 2.58),
     (-0.49, 0.0, 0.53), (0.32, 0.0, 0.77)],
    [(39, 40, 19, 18), (41, 24, 19, 40), (42, 15, 14, 39), (17, 16, 26, 27), (17, 27, 25, 18), (7, 35, 34, 6),
     (5, 33, 32, 4), (3, 31, 30, 2), (1, 29, 28, 0), (0, 28, 35, 7), (6, 34, 33, 5), (4, 32, 31, 3), (2, 30, 29, 1),
     (22, 21, 37, 38), (21, 20, 36, 37), (20, 19, 24, 36), (25, 42, 39, 18), (12, 41, 40, 13), (14, 13, 40, 39),
     (11, 10, 45, 46), (10, 9, 44, 45), (9, 8, 43, 44), (24, 41, 12, 47), (12, 11, 46, 47), (25, 48, 15, 42),
     (15, 48, 43, 8), (49, 23, 22, 38), (23, 49, 26, 16), (34, 35, 52, 51), (33, 34, 51, 50), (49, 51, 52, 26),
     (38, 50, 51, 49), (47, 46, 53, 54), (24, 47, 54, 36), (32, 33, 50, 56), (36, 54, 56, 37), (37, 56, 50, 38),
     (54, 53, 55, 57), (56, 54, 57, 32), (32, 57, 55, 31), (46, 45, 58, 59), (46, 59, 55, 53), (59, 58, 60, 61),
     (55, 59, 61, 31), (30, 31, 61, 60), (43, 48, 63, 62), (27, 63, 48, 25), (30, 60, 65, 29), (60, 58, 64, 65),
     (44, 64, 58, 45), (44, 43, 62, 64), (29, 65, 67, 66), (65, 64, 62, 67), (63, 27, 68, 69), (63, 69, 67, 62),
     (27, 26, 52, 68), (28, 29, 66, 70), (66, 67, 69, 70), (69, 68, 52, 70), (28, 70, 52, 35)],
    [(39, 18), (2, 30), (14, 39), (10, 45), (45, 58), (58, 60), (30, 60)])



root = Module(
    # entree
    [],
    # sortie
    (1, [0, 1, 2, 3, 4, 5, 6, 7]),
    # verts
    [Vector((0.0, 0.9928191900253296, 0.9806214570999146)),
     Vector((-0.7020291090011597, 0.7020291090011597, 0.9806214570999146)),
     Vector((-0.9928191900253296, -4.3397506033215905e-08, 0.9806214570999146)),
     Vector((-0.7020291090011597, -0.7020291090011597, 0.9806214570999146)),
     Vector((8.679501206643181e-08, -0.9928191900253296, 0.9806214570999146)),
     Vector((0.7020292282104492, -0.7020290493965149, 0.9806214570999146)),
     Vector((0.9928191900253296, 1.1839250468881346e-08, 0.9806214570999146)),
     Vector((0.7020292282104492, 0.7020291090011597, 0.9806214570999146)),
     Vector((0.0, 1.0136922597885132, 0.45493215322494507)),
     Vector((-0.716788649559021, 0.716788649559021, 0.45493215322494507)),
     Vector((-1.0136922597885132, -4.4309896196637055e-08, 0.45493215322494507)),
     Vector((-0.716788649559021, -0.716788649559021, 0.45493215322494507)),
     Vector((8.861979239327411e-08, -1.0136922597885132, 0.45493215322494507)),
     Vector((0.7167887687683105, -0.7167885303497314, 0.45493215322494507)),
     Vector((1.0136922597885132, 1.2088158918288627e-08, 0.45493215322494507)),
     Vector((0.7167887687683105, 0.7167885899543762, 0.45493215322494507)),
     Vector((0.0, 1.1711314916610718, 0.011928796768188477)),
     Vector((-0.8281149864196777, 0.8281149864196777, 0.011928796768188477)),
     Vector((-1.1711314916610718, -5.119178325685425e-08, 0.011928796768188477)),
     Vector((-0.8281149864196777, -0.8281149864196777, 0.011928796768188477)),
     Vector((1.023835665137085e-07, -1.1711314916610718, 0.011928796768188477)),
     Vector((0.8281151056289673, -0.8281148672103882, 0.011928796768188477)),
     Vector((1.1711314916610718, 1.3965602896348628e-08, 0.011928796768188477)),
     Vector((0.8281151056289673, 0.828114926815033, 0.011928796768188477)),
     Vector((0.0, 1.416882872581482, -0.3086543381214142)),
     Vector((-1.0018874406814575, 1.0018874406814575, -0.3086543381214142)),
     Vector((-1.416882872581482, -6.19339104446226e-08, -0.3086543381214142)),
     Vector((-1.0018874406814575, -1.0018874406814575, -0.3086543381214142)),
     Vector((1.238678208892452e-07, -1.416882872581482, -0.3086543381214142)),
     Vector((1.001887559890747, -1.0018872022628784, -0.3086543381214142)),
     Vector((1.416882872581482, 1.6896155585754968e-08, -0.3086543381214142)),
     Vector((1.001887559890747, 1.001887321472168, -0.3086543381214142))],
    # faces
    [(7, 6, 14, 15), (5, 4, 12, 13), (3, 2, 10, 11), (1, 0, 8, 9), (0, 7, 15, 8), (6, 5, 13, 14),
     (4, 3, 11, 12), (2, 1, 9, 10), (9, 8, 16, 17), (8, 15, 23, 16), (14, 13, 21, 22), (12, 11, 19, 20),
     (10, 9, 17, 18), (15, 14, 22, 23), (13, 12, 20, 21), (11, 10, 18, 19), (16, 23, 31, 24),
     (22, 21, 29, 30), (20, 19, 27, 28), (18, 17, 25, 26), (23, 22, 30, 31), (21, 20, 28, 29),
     (19, 18, 26, 27), (17, 16, 24, 25)])

branch = Module(
    # entree
    [0, 1, 2, 3, 4, 5, 6, 7],
    # sortie
    (1, [0, 1, 2, 3, 4, 5, 6, 7]),
    # verts
    [Vector((0.0, 1.0, 0.0)),
     Vector((-0.7071067690849304, 0.7071067690849304, 0.0)),
     Vector((-1.0, -4.371138828673793e-08, 0.0)),
     Vector((-0.7071067690849304, -0.7071067690849304, 0.0)),
     Vector((8.742277657347586e-08, -1.0, 0.0)),
     Vector((0.70710688829422, -0.7071066498756409, 0.0)),
     Vector((1.0, 1.1924880638503055e-08, 0.0)),
     Vector((0.70710688829422, 0.7071067094802856, 0.0))],
    # faces
    [])

trunk = Split(
    # entree
    [0, 1, 2, 3, 4, 5, 6, 7],
    # sortie
    ([8, 9, 10, 11, 12, 13, 14, 15], [55, 56, 57, 58, 59, 60, 61, 62]),
    # verts1
    [(0.0, 1.0, -0.0), (-0.71, 0.71, -0.0), (-1.0, -0.0, -0.0), (-0.71, -0.71, -0.0), (0.0, -1.0, -0.0),
     (0.71, -0.71, -0.0), (1.0, 0.0, -0.0), (0.71, 0.71, -0.0), (0.0, 0.98, 1.37), (-0.69, 0.69, 1.37),
     (-0.98, -0.0, 1.37), (-0.75, -0.64, 1.38), (0.0, -0.91, 1.4), (0.75, -0.64, 1.38), (0.98, 0.0, 1.37),
     (0.69, 0.69, 1.37), (0.0, -0.95, 1.39), (-0.51, -0.89, 1.21), (-0.64, -1.01, 0.75), (-0.47, -1.22, 0.35),
     (0.0, -1.34, 0.25), (0.47, -1.22, 0.35), (0.64, -1.01, 0.75), (0.51, -0.89, 1.21), (0.99, -0.04, 0.17),
     (0.99, -0.04, 1.07), (0.7, 0.7, 1.07), (0.7, 0.7, 0.17), (0.0, -1.23, 0.15), (0.0, -0.93, 1.38),
     (0.66, -0.74, 1.28), (0.59, -1.03, 0.18), (-0.99, -0.0, 0.17), (-0.99, -0.0, 1.07), (-0.66, -0.74, 1.28),
     (-0.59, -1.03, 0.18), (0.0, 0.99, 0.17), (0.0, 0.99, 1.07), (-0.7, 0.7, 1.07), (-0.7, 0.7, 0.17),
     (0.96, -0.11, 0.62), (0.7, 0.7, 0.62), (0.72, -0.8, 0.63), (-0.96, -0.11, 0.62), (-0.72, -0.8, 0.63),
     (0.0, 0.99, 0.62), (-0.7, 0.7, 0.62), (0.0, -1.0, 1.43), (-0.43, -1.09, 1.3), (-0.6, -1.38, 0.99),
     (-0.41, -1.66, 0.69), (0.0, -1.78, 0.57), (0.41, -1.66, 0.69), (0.6, -1.38, 0.99), (0.43, -1.09, 1.3),
     (0.0, -1.08, 1.49), (-0.42, -1.23, 1.41), (-0.59, -1.6, 1.22), (-0.42, -1.98, 1.03), (0.0, -2.13, 0.95),
     (0.42, -1.98, 1.03), (0.59, -1.6, 1.22), (0.42, -1.23, 1.41), (0, 0, 1), (0, -0.35, 0.59)],
    # verts2
    [(0.0, 1.0, -0.04), (-0.71, 0.71, -0.04), (-1.0, -0.0, -0.04), (-0.71, -0.71, -0.04), (0.0, -0.98, -0.04),
     (0.71, -0.71, -0.04), (1.0, 0.0, -0.04), (0.71, 0.71, -0.04), (0.0, 0.98, 1.31), (-0.69, 0.69, 1.31),
     (-0.98, -0.0, 1.31), (-0.69, -0.69, 1.31), (0.0, -0.95, 1.31), (0.69, -0.69, 1.31), (0.98, 0.0, 1.31),
     (0.69, 0.69, 1.31), (0.0, -1.02, 1.24), (-0.45, -0.95, 1.07), (-0.59, -0.91, 0.63), (-0.46, -0.96, 0.2),
     (0.0, -1.03, 0.02), (0.46, -0.96, 0.2), (0.59, -0.91, 0.63), (0.45, -0.95, 1.07), (0.99, -0.04, 0.17),
     (0.99, -0.04, 1.07), (0.7, 0.7, 1.07), (0.7, 0.7, 0.17), (0.0, -0.99, -0.01), (0.0, -0.99, 1.25),
     (0.59, -0.85, 1.14), (0.6, -0.85, 0.11), (-0.99, -0.0, 0.17), (-0.99, -0.0, 1.07), (-0.59, -0.85, 1.14),
     (-0.6, -0.85, 0.11), (0.0, 0.99, 0.17), (0.0, 0.99, 1.07), (-0.7, 0.7, 1.07), (-0.7, 0.7, 0.17),
     (0.96, -0.11, 0.62), (0.7, 0.7, 0.62), (0.69, -0.75, 0.62), (-0.96, -0.11, 0.62), (-0.69, -0.75, 0.62),
     (0.0, 0.99, 0.62), (-0.7, 0.7, 0.62), (-0.0, -1.11, 1.19), (-0.39, -1.11, 1.03), (-0.55, -1.11, 0.64),
     (-0.39, -1.11, 0.25), (0.0, -1.1, 0.09), (0.39, -1.11, 0.25), (0.55, -1.11, 0.64), (0.39, -1.11, 1.03),
     (0.0, -1.27, 1.18), (-0.38, -1.27, 1.02), (-0.54, -1.26, 0.65), (-0.38, -1.25, 0.27), (0.0, -1.25, 0.11),
     (0.38, -1.25, 0.27), (0.54, -1.26, 0.65), (0.38, -1.27, 1.02), (0, 0, 1), (0, -1, 0)],
    # faces
    [(26, 15, 14, 25), (30, 13, 12, 29), (34, 11, 10, 33), (38, 9, 8, 37), (37, 8, 15, 26), (25, 14, 13, 30),
     (29, 12, 11, 34), (33, 10, 9, 38), (2, 32, 39, 1), (43, 33, 38, 46), (4, 28, 35, 3), (6, 24, 31, 5),
     (40, 25, 30, 42), (0, 36, 27, 7), (45, 37, 26, 41), (1, 39, 36, 0), (46, 38, 37, 45), (3, 35, 32, 2),
     (44, 34, 33, 43), (5, 31, 28, 4), (7, 27, 24, 6), (41, 26, 25, 40), (27, 41, 40, 24), (35, 44, 43, 32),
     (39, 46, 45, 36), (36, 45, 41, 27), (24, 40, 42, 31), (32, 43, 46, 39), (17, 34, 44, 18), (18, 44, 35, 19),
     (19, 35, 28, 20), (20, 28, 31, 21), (21, 31, 42, 22), (22, 42, 30, 23), (23, 30, 29, 16), (16, 29, 34, 17),
     (16, 47, 54, 23), (23, 54, 53, 22), (22, 53, 52, 21), (21, 52, 51, 20), (20, 51, 50, 19), (19, 50, 49, 18),
     (18, 49, 48, 17), (17, 48, 47, 16), (53, 54, 62, 61), (51, 52, 60, 59), (49, 50, 58, 57), (47, 48, 56, 55),
     (54, 47, 55, 62), (52, 53, 61, 60), (50, 51, 59, 58), (48, 49, 57, 56)],
    # seams
    [(29, 12), (4, 28), (28, 20), (29, 16), (16, 47), (51, 20), (59, 51), (55, 47)])


trunk2 = Split(
    [0, 1, 2, 3, 4, 5, 6, 7],
    ([8, 9, 10, 11, 12, 13, 14, 15],
     [16, 17, 18, 19, 20, 21, 22, 23]),
    [(0.39, 0.92, 0.0), (-0.38, 0.93, 0.0), (-0.92, 0.39, 0.0), (-0.93, -0.38, 0.0), (-0.39, -0.92, 0.0),
     (0.38, -0.93, 0.0), (0.92, -0.39, 0.0), (0.93, 0.38, 0.0), (0.24, 0.93, 1.83), (-0.53, 0.92, 1.83),
     (-1.06, 0.38, 1.83), (-1.06, -0.39, 1.83), (-0.51, -0.93, 1.83), (0.25, -0.92, 1.83), (0.79, -0.38, 1.83),
     (0.78, 0.39, 1.83), (1.46, 0.36, 1.35), (1.2, 0.36, 1.52), (1.02, 0.14, 1.65), (1.02, -0.17, 1.64),
     (1.2, -0.39, 1.52), (1.46, -0.39, 1.34), (1.64, -0.17, 1.22), (1.64, 0.14, 1.22), (1.39, 0.2, 0.88),
     (1.39, -0.19, 0.88), (1.2, -0.64, 1.11), (1.11, -0.6, 1.29), (1.17, 0.29, 0.53), (1.17, -0.29, 0.52),
     (0.84, -0.53, 1.69), (0.63, -0.82, 1.6), (0.99, 0.5, 1.68), (1.08, 0.69, 1.3), (1.17, 0.61, 1.07),
     (0.76, 0.85, 1.61), (0.31, 0.96, 1.32), (-0.45, 0.96, 1.32), (-1.0, 0.42, 1.32), (-1.0, -0.34, 1.32),
     (-0.46, -0.89, 1.32), (0.31, -0.89, 1.32), (0.68, -0.83, 1.22), (1.1, -0.63, 0.67), (0.66, -0.77, 0.67),
     (0.89, -0.69, 0.22), (0.35, -0.91, 0.46), (-0.95, -0.37, 0.46), (-0.41, -0.91, 0.46), (-0.41, 0.94, 0.46),
     (-0.95, 0.4, 0.46), (1.04, 0.59, 0.68), (0.36, 0.94, 0.46), (0.82, 0.73, 0.38), (0.65, 0.82, 0.74),
     (0.69, 0.87, 1.19), (-0.1, -0.05, 1.94), (-0.12, -0.05, 2.89), (1.33, -0.05, 1.48), (1.9, -0.05, 2.25),
     (-0.02, 0.0, 0.95), (0.57, 0.0, 0.77)],
    [(0.39, 0.92, 0.0), (-0.38, 0.93, 0.0), (-0.92, 0.39, 0.0), (-0.93, -0.38, 0.0), (-0.39, -0.92, 0.0),
     (0.38, -0.93, 0.0), (0.92, -0.39, 0.0), (0.92, 0.38, 0.0), (0.24, 0.93, 1.83), (-0.53, 0.92, 1.83),
     (-1.06, 0.38, 1.83), (-1.06, -0.39, 1.83), (-0.51, -0.93, 1.83), (0.25, -0.92, 1.83), (0.81, -0.38, 1.85),
     (0.8, 0.39, 1.85), (1.26, 0.36, 1.19), (1.18, 0.36, 1.49), (1.1, 0.14, 1.7), (1.11, -0.17, 1.69),
     (1.18, -0.39, 1.49), (1.26, -0.39, 1.19), (1.29, -0.17, 0.97), (1.29, 0.14, 0.97), (1.17, 0.2, 0.8),
     (1.17, -0.19, 0.8), (1.11, -0.64, 1.08), (1.02, -0.6, 1.27), (1.03, 0.29, 0.51), (1.03, -0.29, 0.51),
     (0.84, -0.53, 1.7), (0.63, -0.82, 1.6), (0.99, 0.5, 1.67), (1.03, 0.69, 1.29), (1.08, 0.61, 1.05),
     (0.76, 0.85, 1.61), (0.31, 0.96, 1.32), (-0.45, 0.96, 1.32), (-1.0, 0.42, 1.32), (-1.0, -0.34, 1.32),
     (-0.46, -0.89, 1.32), (0.31, -0.89, 1.32), (0.68, -0.83, 1.22), (1.02, -0.63, 0.67), (0.65, -0.77, 0.67),
     (0.88, -0.69, 0.22), (0.35, -0.91, 0.46), (-0.95, -0.37, 0.46), (-0.41, -0.91, 0.46), (-0.41, 0.94, 0.46),
     (-0.95, 0.4, 0.46), (0.95, 0.59, 0.68), (0.36, 0.94, 0.46), (0.81, 0.73, 0.38), (0.65, 0.82, 0.74),
     (0.69, 0.87, 1.19), (-0.13, -0.05, 1.94), (-0.1, -0.05, 2.89), (0.94, -0.05, 1.26), (2.19, -0.05, 1.53),
     (0.03, 0.0, 0.95), (1.25, 0.0, 0.27)],
    [(15, 14, 19, 18), (23, 22, 25, 24), (20, 27, 26, 21), (21, 26, 25, 22), (6, 7, 28, 29), (25, 29, 28, 24),
     (20, 30, 31, 27), (20, 19, 14, 30), (14, 13, 31, 30), (17, 32, 15, 18), (16, 34, 33, 17), (16, 23, 24, 34),
     (32, 17, 33, 35), (8, 15, 32, 35), (48, 40, 39, 47), (50, 38, 37, 49), (46, 41, 40, 48), (47, 39, 38, 50),
     (49, 37, 36, 52), (12, 40, 41, 13), (11, 39, 40, 12), (10, 38, 39, 11), (9, 37, 38, 10), (8, 36, 37, 9),
     (42, 26, 27, 31), (31, 13, 41, 42), (26, 42, 44, 43), (25, 26, 43, 29), (43, 44, 46, 45), (29, 43, 45, 6),
     (5, 6, 45, 46), (1, 49, 52, 0), (3, 47, 50, 2), (5, 46, 48, 4), (2, 50, 49, 1), (4, 48, 47, 3), (41, 46, 44, 42),
     (51, 34, 24, 28), (51, 28, 7, 53), (0, 52, 53, 7), (51, 53, 52, 54), (36, 55, 54, 52), (35, 55, 36, 8),
     (34, 55, 35, 33), (34, 51, 54, 55)],
    [(14, 19), (22, 25), (25, 29), (6, 29)])

trunk3 = Split(
    [0, 1, 2, 3, 4, 5, 6, 7],
    ([8, 9, 10, 11, 12, 13, 14, 15],
     [16, 17, 18, 19, 20, 21, 22, 23]),
    [(0.39, 0.92, 0.0), (-0.38, 0.93, 0.0), (-0.92, 0.39, 0.0), (-0.93, -0.38, 0.0), (-0.39, -0.92, 0.0),
     (0.38, -0.93, 0.0), (0.92, -0.39, 0.0), (0.93, 0.38, 0.0), (0.24, 0.93, 1.83), (-0.53, 0.92, 1.83),
     (-1.06, 0.38, 1.83), (-1.06, -0.39, 1.83), (-0.51, -0.93, 1.83), (0.25, -0.92, 1.83), (0.79, -0.38, 1.83),
     (0.78, 0.39, 1.83), (1.51, 0.44, 1.48), (1.2, 0.44, 1.69), (0.99, 0.17, 1.83), (0.99, -0.2, 1.83),
     (1.21, -0.46, 1.68), (1.51, -0.46, 1.47), (1.73, -0.2, 1.32), (1.73, 0.18, 1.32), (1.39, 0.2, 0.88),
     (1.39, -0.19, 0.88), (1.2, -0.64, 1.11), (1.11, -0.6, 1.29), (1.17, 0.29, 0.53), (1.17, -0.29, 0.52),
     (0.84, -0.53, 1.69), (0.63, -0.82, 1.6), (0.99, 0.5, 1.68), (1.08, 0.69, 1.3), (1.17, 0.61, 1.07),
     (0.76, 0.85, 1.61), (0.31, 0.96, 1.32), (-0.45, 0.96, 1.32), (-1.0, 0.42, 1.32), (-1.0, -0.34, 1.32),
     (-0.46, -0.89, 1.32), (0.31, -0.89, 1.32), (0.68, -0.83, 1.22), (1.1, -0.63, 0.67), (0.66, -0.77, 0.67),
     (0.89, -0.69, 0.22), (0.35, -0.91, 0.46), (-0.95, -0.37, 0.46), (-0.41, -0.91, 0.46), (-0.41, 0.94, 0.46),
     (-0.95, 0.4, 0.46), (1.04, 0.59, 0.68), (0.36, 0.94, 0.46), (0.82, 0.73, 0.38), (0.65, 0.82, 0.74),
     (0.69, 0.87, 1.19), (-0.1, -0.05, 1.94), (-0.12, -0.05, 2.89), (1.33, -0.05, 1.48), (1.9, -0.05, 2.25),
     (-0.02, 0.0, 0.95), (0.57, 0.0, 0.77)],
    [(0.39, 0.92, 0.0), (-0.38, 0.93, 0.0), (-0.92, 0.39, 0.0), (-0.93, -0.38, 0.0), (-0.39, -0.92, 0.0),
     (0.38, -0.93, 0.0), (0.92, -0.39, 0.0), (0.92, 0.38, 0.0), (0.24, 0.93, 1.83), (-0.53, 0.92, 1.83),
     (-1.06, 0.38, 1.83), (-1.06, -0.39, 1.83), (-0.51, -0.93, 1.83), (0.25, -0.92, 1.83), (0.81, -0.38, 1.85),
     (0.8, 0.39, 1.85), (1.31, 0.44, 1.32), (1.18, 0.44, 1.66), (1.07, 0.17, 1.88), (1.07, -0.2, 1.88),
     (1.19, -0.46, 1.65), (1.31, -0.46, 1.32), (1.38, -0.2, 1.07), (1.38, 0.18, 1.07), (1.17, 0.2, 0.8),
     (1.17, -0.19, 0.8), (1.11, -0.64, 1.08), (1.02, -0.6, 1.27), (1.03, 0.29, 0.51), (1.03, -0.29, 0.51),
     (0.84, -0.53, 1.7), (0.63, -0.82, 1.6), (0.99, 0.5, 1.67), (1.03, 0.69, 1.29), (1.08, 0.61, 1.05),
     (0.76, 0.85, 1.61), (0.31, 0.96, 1.32), (-0.45, 0.96, 1.32), (-1.0, 0.42, 1.32), (-1.0, -0.34, 1.32),
     (-0.46, -0.89, 1.32), (0.31, -0.89, 1.32), (0.68, -0.83, 1.22), (1.02, -0.63, 0.67), (0.65, -0.77, 0.67),
     (0.88, -0.69, 0.22), (0.35, -0.91, 0.46), (-0.95, -0.37, 0.46), (-0.41, -0.91, 0.46), (-0.41, 0.94, 0.46),
     (-0.95, 0.4, 0.46), (0.95, 0.59, 0.68), (0.36, 0.94, 0.46), (0.81, 0.73, 0.38), (0.65, 0.82, 0.74),
     (0.69, 0.87, 1.19), (-0.13, -0.05, 1.94), (-0.1, -0.05, 2.89), (0.94, -0.05, 1.26), (2.19, -0.05, 1.53),
     (0.03, 0.0, 0.95), (1.25, 0.0, 0.27)],
    [(15, 14, 19, 18), (23, 22, 25, 24), (20, 27, 26, 21), (21, 26, 25, 22), (6, 7, 28, 29), (25, 29, 28, 24),
     (20, 30, 31, 27), (20, 19, 14, 30), (14, 13, 31, 30), (17, 32, 15, 18), (16, 34, 33, 17), (16, 23, 24, 34),
     (32, 17, 33, 35), (8, 15, 32, 35), (48, 40, 39, 47), (50, 38, 37, 49), (46, 41, 40, 48), (47, 39, 38, 50),
     (49, 37, 36, 52), (12, 40, 41, 13), (11, 39, 40, 12), (10, 38, 39, 11), (9, 37, 38, 10), (8, 36, 37, 9),
     (42, 26, 27, 31), (31, 13, 41, 42), (26, 42, 44, 43), (25, 26, 43, 29), (43, 44, 46, 45), (29, 43, 45, 6),
     (5, 6, 45, 46), (1, 49, 52, 0), (3, 47, 50, 2), (5, 46, 48, 4), (2, 50, 49, 1), (4, 48, 47, 3),
     (41, 46, 44, 42), (51, 34, 24, 28), (51, 28, 7, 53), (0, 52, 53, 7), (51, 53, 52, 54), (36, 55, 54, 52),
     (35, 55, 36, 8), (34, 55, 35, 33), (34, 51, 54, 55)],
    [(14, 19), (22, 25), (25, 29), (6, 29)])

trunk4 = Split(
    [0, 1, 2, 3, 4, 5, 6, 7],
    ([8, 9, 10, 11, 12, 13, 14, 15],
     [16, 17, 18, 19, 20, 21, 22, 23]),
    [(0.39, 0.92, 0.0), (-0.38, 0.93, 0.0), (-0.92, 0.39, 0.0), (-0.93, -0.38, 0.0), (-0.39, -0.92, 0.0),
     (0.38, -0.93, 0.0), (0.92, -0.39, 0.0), (0.93, 0.38, 0.0), (0.24, 0.93, 1.83), (-0.53, 0.92, 1.83),
     (-1.06, 0.38, 1.83), (-1.06, -0.39, 1.83), (-0.51, -0.93, 1.83), (0.25, -0.92, 1.83), (0.79, -0.38, 1.83),
     (0.78, 0.39, 1.83), (1.54, 0.53, 1.45), (1.17, 0.53, 1.71), (0.91, 0.21, 1.89), (0.92, -0.24, 1.88),
     (1.18, -0.55, 1.7), (1.54, -0.55, 1.45), (1.8, -0.23, 1.27), (1.8, 0.21, 1.27), (1.39, 0.2, 0.88),
     (1.39, -0.19, 0.88), (1.2, -0.64, 1.11), (1.11, -0.6, 1.29), (1.17, 0.29, 0.53), (1.17, -0.29, 0.52),
     (0.84, -0.53, 1.69), (0.63, -0.82, 1.6), (0.99, 0.5, 1.68), (1.08, 0.69, 1.3), (1.17, 0.61, 1.07),
     (0.76, 0.85, 1.61), (0.31, 0.96, 1.32), (-0.45, 0.96, 1.32), (-1.0, 0.42, 1.32), (-1.0, -0.34, 1.32),
     (-0.46, -0.89, 1.32), (0.31, -0.89, 1.32), (0.68, -0.83, 1.22), (1.1, -0.63, 0.67), (0.66, -0.77, 0.67),
     (0.89, -0.69, 0.22), (0.35, -0.91, 0.46), (-0.95, -0.37, 0.46), (-0.41, -0.91, 0.46), (-0.41, 0.94, 0.46),
     (-0.95, 0.4, 0.46), (1.04, 0.59, 0.68), (0.36, 0.94, 0.46), (0.82, 0.73, 0.38), (0.65, 0.82, 0.74),
     (0.69, 0.87, 1.19), (-0.1, -0.05, 1.94), (-0.12, -0.05, 2.89), (1.33, -0.05, 1.48), (1.9, -0.05, 2.25),
     (-0.02, 0.0, 0.95), (0.57, 0.0, 0.77)],
    [(0.39, 0.92, 0.0), (-0.38, 0.93, 0.0), (-0.92, 0.39, 0.0), (-0.93, -0.38, 0.0), (-0.39, -0.92, 0.0),
     (0.38, -0.93, 0.0), (0.92, -0.39, 0.0), (0.92, 0.38, 0.0), (0.24, 0.93, 1.83), (-0.53, 0.92, 1.83),
     (-1.06, 0.38, 1.83), (-1.06, -0.39, 1.83), (-0.51, -0.93, 1.83), (0.25, -0.92, 1.83), (0.81, -0.38, 1.85),
     (0.8, 0.39, 1.85), (1.34, 0.53, 1.3), (1.15, 0.53, 1.68), (1.0, 0.21, 1.94), (1.0, -0.24, 1.93),
     (1.15, -0.55, 1.67), (1.34, -0.55, 1.29), (1.46, -0.23, 1.02), (1.46, 0.21, 1.02), (1.17, 0.2, 0.8),
     (1.17, -0.19, 0.8), (1.11, -0.64, 1.08), (1.02, -0.6, 1.27), (1.03, 0.29, 0.51), (1.03, -0.29, 0.51),
     (0.84, -0.53, 1.7), (0.63, -0.82, 1.6), (0.99, 0.5, 1.67), (1.03, 0.69, 1.29), (1.08, 0.61, 1.05),
     (0.76, 0.85, 1.61), (0.31, 0.96, 1.32), (-0.45, 0.96, 1.32), (-1.0, 0.42, 1.32), (-1.0, -0.34, 1.32),
     (-0.46, -0.89, 1.32), (0.31, -0.89, 1.32), (0.68, -0.83, 1.22), (1.02, -0.63, 0.67), (0.65, -0.77, 0.67),
     (0.88, -0.69, 0.22), (0.35, -0.91, 0.46), (-0.95, -0.37, 0.46), (-0.41, -0.91, 0.46), (-0.41, 0.94, 0.46),
     (-0.95, 0.4, 0.46), (0.95, 0.59, 0.68), (0.36, 0.94, 0.46), (0.81, 0.73, 0.38), (0.65, 0.82, 0.74),
     (0.69, 0.87, 1.19), (-0.13, -0.05, 1.94), (-0.1, -0.05, 2.89), (0.94, -0.05, 1.26), (2.19, -0.05, 1.53),
     (0.03, 0.0, 0.95), (1.25, 0.0, 0.27)],
    [(15, 14, 19, 18), (23, 22, 25, 24), (20, 27, 26, 21), (21, 26, 25, 22), (6, 7, 28, 29), (25, 29, 28, 24),
     (20, 30, 31, 27), (20, 19, 14, 30), (14, 13, 31, 30), (17, 32, 15, 18), (16, 34, 33, 17), (16, 23, 24, 34),
     (32, 17, 33, 35), (8, 15, 32, 35), (48, 40, 39, 47), (50, 38, 37, 49), (46, 41, 40, 48), (47, 39, 38, 50),
     (49, 37, 36, 52), (12, 40, 41, 13), (11, 39, 40, 12), (10, 38, 39, 11), (9, 37, 38, 10), (8, 36, 37, 9),
     (42, 26, 27, 31), (31, 13, 41, 42), (26, 42, 44, 43), (25, 26, 43, 29), (43, 44, 46, 45), (29, 43, 45, 6),
     (5, 6, 45, 46), (1, 49, 52, 0), (3, 47, 50, 2), (5, 46, 48, 4), (2, 50, 49, 1), (4, 48, 47, 3), (41, 46, 44, 42),
     (51, 34, 24, 28), (51, 28, 7, 53), (0, 52, 53, 7), (51, 53, 52, 54), (36, 55, 54, 52), (35, 55, 36, 8),
     (34, 55, 35, 33), (34, 51, 54, 55)],
    [(14, 19), (22, 25), (25, 29), (6, 29)])

trunk5 = Split(
    [0, 1, 2, 3, 4, 5, 6, 7],
    ([8, 9, 10, 11, 12, 13, 14, 15],
     [16, 17, 18, 19, 20, 21, 22, 23]),
    [(0.39, 0.92, 0.0), (-0.38, 0.93, 0.0), (-0.92, 0.39, 0.0), (-0.93, -0.38, 0.0), (-0.39, -0.92, 0.0),
     (0.38, -0.93, 0.0), (0.92, -0.39, 0.0), (0.93, 0.38, 0.0), (0.26, 0.94, 1.85), (-0.53, 0.92, 1.83),
     (-1.06, 0.38, 1.83), (-1.06, -0.39, 1.83), (-0.51, -0.93, 1.83), (0.27, -0.94, 1.85), (0.8, -0.51, 2.01),
     (0.79, 0.53, 2.0), (1.87, 0.74, 1.51), (1.35, 0.74, 1.86), (0.99, 0.3, 2.11), (0.99, -0.33, 2.11),
     (1.36, -0.77, 1.86), (1.87, -0.76, 1.5), (2.23, -0.32, 1.25), (2.23, 0.3, 1.25), (1.63, 0.23, 0.74),
     (1.63, -0.22, 0.74), (1.28, -0.78, 1.05), (1.18, -0.75, 1.28), (1.33, 0.29, 0.46), (1.33, -0.29, 0.46),
     (0.85, -0.69, 1.79), (0.62, -0.95, 1.64), (1.08, 0.69, 1.8), (1.14, 0.85, 1.29), (1.24, 0.72, 1.01),
     (0.76, 1.02, 1.66), (0.32, 0.96, 1.32), (-0.45, 0.96, 1.32), (-1.0, 0.42, 1.32), (-1.0, -0.34, 1.32),
     (-0.46, -0.89, 1.32), (0.31, -0.89, 1.32), (0.67, -0.85, 1.22), (1.11, -0.65, 0.66), (0.66, -0.77, 0.67),
     (0.89, -0.69, 0.22), (0.35, -0.91, 0.46), (-0.95, -0.37, 0.46), (-0.41, -0.91, 0.46), (-0.41, 0.94, 0.46),
     (-0.95, 0.4, 0.46), (1.04, 0.6, 0.67), (0.36, 0.94, 0.46), (0.82, 0.73, 0.38), (0.65, 0.82, 0.74),
     (0.69, 0.89, 1.18), (-0.1, -0.05, 1.94), (-0.12, -0.05, 2.89), (1.33, -0.05, 1.48), (1.9, -0.05, 2.25),
     (-0.02, 0.0, 0.95), (0.57, 0.0, 0.77)],
    [(0.39, 0.92, 0.0), (-0.38, 0.93, 0.0), (-0.92, 0.39, 0.0), (-0.93, -0.38, 0.0), (-0.39, -0.92, 0.0),
     (0.38, -0.93, 0.0), (0.92, -0.39, 0.0), (0.92, 0.38, 0.0), (0.26, 0.94, 1.85), (-0.53, 0.92, 1.83),
     (-1.06, 0.38, 1.83), (-1.06, -0.39, 1.83), (-0.51, -0.93, 1.83), (0.27, -0.94, 1.85), (0.82, -0.51, 2.03),
     (0.81, 0.53, 2.02), (1.67, 0.74, 1.35), (1.33, 0.74, 1.83), (1.08, 0.3, 2.16), (1.08, -0.33, 2.16),
     (1.34, -0.77, 1.82), (1.67, -0.76, 1.34), (1.89, -0.32, 1.0), (1.89, 0.3, 1.0), (1.42, 0.23, 0.66),
     (1.41, -0.22, 0.66), (1.19, -0.78, 1.02), (1.09, -0.75, 1.25), (1.19, 0.29, 0.45), (1.19, -0.29, 0.45),
     (0.85, -0.69, 1.8), (0.62, -0.95, 1.64), (1.07, 0.69, 1.8), (1.09, 0.85, 1.28), (1.15, 0.72, 0.99),
     (0.76, 1.02, 1.66), (0.32, 0.96, 1.32), (-0.45, 0.96, 1.32), (-1.0, 0.42, 1.32), (-1.0, -0.34, 1.32),
     (-0.46, -0.89, 1.32), (0.31, -0.89, 1.32), (0.67, -0.85, 1.22), (1.03, -0.65, 0.65), (0.65, -0.77, 0.67),
     (0.88, -0.69, 0.22), (0.35, -0.91, 0.46), (-0.95, -0.37, 0.46), (-0.41, -0.91, 0.46), (-0.41, 0.94, 0.46),
     (-0.95, 0.4, 0.46), (0.96, 0.6, 0.67), (0.36, 0.94, 0.46), (0.81, 0.73, 0.38), (0.65, 0.82, 0.74),
     (0.69, 0.89, 1.18), (-0.13, -0.05, 1.94), (-0.1, -0.05, 2.89), (0.94, -0.05, 1.26), (2.19, -0.05, 1.53),
     (0.03, 0.0, 0.95), (1.25, 0.0, 0.27)],
    [(15, 14, 19, 18), (23, 22, 25, 24), (20, 27, 26, 21), (21, 26, 25, 22), (6, 7, 28, 29), (25, 29, 28, 24),
     (20, 30, 31, 27), (20, 19, 14, 30), (14, 13, 31, 30), (17, 32, 15, 18), (16, 34, 33, 17), (16, 23, 24, 34),
     (32, 17, 33, 35), (8, 15, 32, 35), (48, 40, 39, 47), (50, 38, 37, 49), (46, 41, 40, 48), (47, 39, 38, 50),
     (49, 37, 36, 52), (12, 40, 41, 13), (11, 39, 40, 12), (10, 38, 39, 11), (9, 37, 38, 10), (8, 36, 37, 9),
     (42, 26, 27, 31), (31, 13, 41, 42), (26, 42, 44, 43), (25, 26, 43, 29), (43, 44, 46, 45), (29, 43, 45, 6),
     (5, 6, 45, 46), (1, 49, 52, 0), (3, 47, 50, 2), (5, 46, 48, 4), (2, 50, 49, 1), (4, 48, 47, 3), (41, 46, 44, 42),
     (51, 34, 24, 28), (51, 28, 7, 53), (0, 52, 53, 7), (51, 53, 52, 54), (36, 55, 54, 52), (35, 55, 36, 8),
     (34, 55, 35, 33), (34, 51, 54, 55)],
    [(14, 19), (22, 25), (25, 29), (6, 29)])

Trunks = [trunk, trunk2, trunk3, trunk4, trunk5]
Joncts = [S1, S2, S3, S4, trunk,trunk2,trunk5]

class Trunk:
    """This is used to represent the base of a trunk with roots"""
    def __init__(self, roots, stem, verts, faces, seams):
        """Initializes the variables

        Args:
            roots - (list of (Vector, list of int)) The directions and indexes of roots exits
            stem - (list of int) The indexes of the trunk exit
            verts - (list of Vector) The vertices
            faces - (list of (int, int, int, int)) The faces
            seams - (list of (int, int)) The seams
        """
        self.roots = roots
        self.stem = stem
        self.verts = verts
        self.faces = faces
        self.Seams = seams


R1 = Trunk(
    # roots
    [(Vector((-6.293336696217011e-08, -0.6988458633422852, -0.3152722477912903)), 0.69, [110, 111, 112, 113, 114, 115, 116, 117]),
     (Vector((0.6009913086891174, -0.04263520613312721, -0.3981175780296326)), 0.34, [55, 56, 57, 58, 59, 60, 61, 62]),
     (Vector((0.5693859457969666, 0.49961066246032715, -0.352831494808197)), 0.34, [47, 48, 49, 50, 51, 52, 53, 54]),
     (Vector((-0.779069721698761, 0.455067813396454, -0.24110554456710815)), 0.34, [63, 64, 65, 66, 67, 68, 69, 70, 101]),
     (Vector((-0.7720233201980591, -0.09697314351797104, -0.3281529068946838)), 0.56, [71, 72, 73, 74, 75, 76, 77, 78]),
     (Vector((-1.859164768802657e-07, 0.2071729600429535, -0.4783042669296265)), 0.60, [39, 40, 41, 42, 43, 44, 45, 46])],
    # stem
    [0, 1, 2, 3, 4, 5, 6, 7],
    # verts
    [(0.0, 0.99, 0.98), (-0.7, 0.7, 0.98), (-0.99, -0.0, 0.98), (-0.7, -0.7, 0.98), (0.0, -0.99, 0.98),
     (0.7, -0.7, 0.98), (0.99, 0.0, 0.98), (0.7, 0.7, 0.98), (0.01, 1.07, 0.58), (-0.74, 0.76, 0.57),
     (-1.06, 0.0, 0.58), (-0.75, -0.75, 0.58), (0.01, -1.07, 0.58), (0.76, -0.75, 0.58), (1.08, 0.0, 0.58),
     (0.76, 0.76, 0.58), (0.01, 1.23, 0.08), (-0.82, 0.88, 0.09), (-1.21, 0.01, 0.08), (-0.86, -0.86, 0.09),
     (0.01, -1.22, 0.09), (0.88, -0.86, 0.09), (1.23, 0.0, 0.09), (0.88, 0.87, 0.09), (0.1, 1.47, -0.3),
     (-0.87, 1.07, -0.26), (-1.43, 0.05, -0.28), (-1.05, -1.0, -0.29), (0.01, -1.58, -0.29), (1.01, -1.04, -0.3),
     (1.44, -0.02, -0.34), (1.02, 1.06, -0.29), (0.01, -0.62, -1.31), (-0.5, -0.77, -1.17), (-0.7, -1.14, -0.84),
     (-0.5, -1.52, -0.5), (0.51, -1.52, -0.5), (0.72, -1.14, -0.84), (0.51, -0.77, -1.17), (0.01, 0.98, -1.09),
     (-0.41, 0.81, -1.12), (-0.58, 0.41, -1.21), (-0.41, 0.01, -1.29), (0.01, -0.16, -1.33), (0.42, 0.01, -1.29),
     (0.59, 0.41, -1.21), (0.42, 0.81, -1.12), (0.73, 1.52, -0.51), (0.51, 1.5, -0.72), (0.43, 1.3, -0.94),
     (0.55, 1.03, -1.04), (0.79, 0.86, -0.96), (1.01, 0.88, -0.75), (1.09, 1.08, -0.53), (0.97, 1.35, -0.43),
     (1.12, 0.28, -0.89), (0.9, 0.21, -1.05), (0.78, -0.03, -1.13), (0.83, -0.3, -1.08), (1.02, -0.44, -0.93),
     (1.24, -0.37, -0.77), (1.36, -0.13, -0.69), (1.31, 0.14, -0.74), (-1.49, 0.49, -0.65), (-1.41, 0.74, -0.54),
     (-1.25, 0.95, -0.62), (-1.09, 1.0, -0.84), (-1.03, 0.86, -1.08), (-1.11, 0.62, -1.19), (-1.27, 0.41, -1.11),
     (-1.43, 0.36, -0.88), (-1.36, -0.85, -0.84), (-1.55, -0.51, -0.66), (-1.55, -0.1, -0.73), (-1.35, 0.16, -1.01),
     (-1.08, 0.11, -1.33), (-0.89, -0.23, -1.51), (-0.9, -0.65, -1.44), (-1.09, -0.91, -1.16), (0.06, 1.52, -0.6),
     (0.03, 1.37, -0.82), (1.22, 0.55, -0.74), (1.42, 0.42, -0.55), (1.0, 0.57, -0.9), (-0.8, 0.67, -1.11),
     (-0.7, 0.94, -0.97), (-0.31, 1.18, -0.88), (-0.42, 1.31, -0.58), (-0.78, 1.14, -0.65), (-1.07, 1.01, -0.44),
     (1.27, -0.5, -0.55), (1.08, -0.92, -0.53), (0.94, -0.96, -0.67), (0.83, -1.26, -0.5), (-0.97, -1.23, -0.5),
     (-1.09, -1.06, -0.66), (-1.36, -0.73, -0.48), (-1.56, -0.12, -0.5), (-1.51, 0.28, -0.56), (-1.39, 0.53, -0.45),
     (-1.51, 0.19, -0.75), (-1.46, 0.42, -0.77), (-0.91, -0.98, -1.01), (-0.72, -0.67, -1.28), (-0.68, -0.14, -1.37),
     (-0.84, 0.26, -1.27), (-1.21, -0.94, -0.76), (-1.45, -0.6, -0.59), (-1.56, -0.12, -0.62), (-1.52, 0.22, -0.66),
     (0.03, -0.95, -1.39), (-0.37, -1.06, -1.27), (-0.54, -1.33, -0.97), (-0.37, -1.6, -0.67), (0.03, -1.71, -0.55),
     (0.43, -1.6, -0.67), (0.6, -1.33, -0.97), (0.43, -1.06, -1.27)],
    # faces
    [(7, 6, 14, 15), (5, 4, 12, 13), (3, 2, 10, 11), (1, 0, 8, 9), (0, 7, 15, 8), (6, 5, 13, 14), (4, 3, 11, 12),
     (2, 1, 9, 10), (9, 8, 16, 17), (8, 15, 23,  16), (14,  13,  21, 22), (12, 11, 19, 20), (10, 9, 17, 18),
     (15, 14, 22, 23), (13, 12, 20, 21), (11, 10, 18, 19), (16, 23, 31, 24), (22, 21, 29, 30), (20, 19, 27, 28),
     (18, 17, 25, 26), (23, 22, 30, 31), (21, 20, 28, 29), (19, 18, 26, 27), (17, 16, 24, 25), (32, 43, 44, 38),
     (33, 42, 43, 32), (103, 102, 78, 77), (104, 42, 33, 103), (105, 104, 76, 75), (45, 56, 57, 44), (57, 58, 38, 44),
     (46, 50, 51, 45), (49, 50, 46, 39), (31, 54, 47, 24), (48, 49, 80, 79), (48, 79, 24, 47), (62, 55, 81, 82),
     (53, 82, 81, 52), (61, 62, 82, 30), (38, 58, 59, 37), (56, 45, 51, 83), (81, 55, 56, 83), (53, 54, 31),
     (52, 81, 83, 51), (30, 82, 53, 31), (40, 41, 84, 85), (85, 84, 68, 67), (86, 80, 49, 39), (39, 40, 85, 86),
     (79, 80, 86, 87), (25, 24, 79, 87), (66, 88, 85, 67), (85, 88, 87, 86), (89, 25, 87, 88), (65, 89, 88, 66),
     (60, 61, 30, 90), (29, 91, 90, 30), (92, 60, 90, 91), (60, 92, 37, 59), (36, 37, 92, 93), (29, 93, 92, 91),
     (29, 28, 36, 93), (27, 94, 35, 28), (106, 71, 78, 102), (34, 35, 94, 95), (107, 72, 71, 106), (96, 95, 94, 27),
     (26, 97, 96, 27), (108, 107, 96, 97), (70, 69, 75, 74), (73, 100, 70, 74), (97, 26, 99, 98), (98, 99, 64, 63),
     (26, 25, 89, 99), (64, 99, 89, 65), (109, 108, 97, 98), (101, 109, 98, 63), (70, 100, 109, 101),
     (100, 73, 108, 109), (73, 72, 107, 108), (96, 107, 106, 95), (95, 106, 102, 34), (41, 42, 104, 105),
     (76, 104, 103, 77), (33, 34, 102, 103), (68, 105, 75, 69), (41, 105, 68, 84), (36, 115, 116, 37),
     (114, 115, 36, 28), (35, 113, 114, 28), (34, 112, 113, 35), (111, 112, 34, 33), (32, 110, 111, 33),
     (38, 117, 110, 32), (37, 116, 117, 38)],
    # seams
    [(0, 8), (8, 16), (24, 16), (80, 79), (24, 79), (39, 86), (80, 86), (40, 39), (41, 40), (42, 41), (43, 42),
     (44, 43), (45, 44), (46, 45), (39, 46), (48, 47), (49, 48), (50, 49), (51, 50), (52, 51), (53, 52), (54, 53),
     (47, 54), (56, 55), (57, 56), (58, 57), (59, 58), (60, 59), (61, 60), (62, 61), (55, 62), (64, 63), (65, 64),
     (66, 65), (67, 66), (68, 67), (69, 68), (70, 69), (101, 70), (72, 71), (73, 72), (74, 73), (75, 74), (76, 75),
     (77, 76), (78, 77), (71, 78), (63, 101), (111, 110), (112, 111), (113, 112), (114, 113), (115, 114), (116, 115),
     (117, 116), (110, 117)])


def joindre(verts, faces, v1_i, v2_i):
    """ Takes two sets of eight vertices, a list of vertices, a list of faces, and adds new faces as the bridge edge loops operator would do.

    Args:
        verts - (list of (Vector, Vector, Vector)) The list of vertices
        faces - (list of (int, int, int, int)) The list of faces
        v1_i - (int, int, int, int, int, int, int, int) The indexes of the first group of vertices
        v2_i - (int, int, int, int, int, int, int, int) The indexes of the second group of vertices
    """
    v1 = verts[v1_i[0]]
    n = len(v2_i)
    d = float('inf')
    decalage = 0
    for i in range(n):
        d1 = (verts[v2_i[i]] - v1).length
        if d1 < d:
            d = d1
            decalage = i
    v2 = verts[v1_i[1]]
    k = 1
    if (verts[v2_i[(decalage + 1) % n]] - v2).length > (verts[v2_i[(decalage - 1) % n]] - v2).length:
        k = -1
    for i in range(n):
        faces.append([v1_i[i], v2_i[(decalage + i * k) % n], v2_i[(decalage + (i + 1) * k) % n], v1_i[(i + 1) % n]])


def join(verts, faces, indexes, object_verts, object_faces, scale, i1, i2, entree, directions, branch_length, s_index,
         seams,
         jonc_seams, random_angle, branch_rotation):
    """ The goal is to add a split to the tree. To do that, there is the list of existing vertices, the list of existing faces, the list of vertices to add and the list of faces to add.
        To know where to add the split, the indexes of eight vertices is given.

    Args:
        verts - (list of (Vector, Vector, Vector)) The existing vertices
        faces - (list of (int, int, int, int)) The existing faces
        indexes - ((int, int, int, int, int, int, int, int)) the indexes of the end of the branch on which the split will be added
        object_verts - (list of (Vector, Vector, Vector)) The vertices to add
        object_faces - (list of (int, int, int, int)) The faces to add
        scale - (float) the scale of which the split must be
        i1 - ((int, int, int, int, int, int, int, int))The indexes of the first end of the split
        i2 - ((int, int, int, int, int, int, int, int)) The indexes of the second end of the split
        entree - ((int, int, int, int, int, int, int, int)) the indexes of the base of the split
        directions - (Vector) The direction the split will be pointing at
        branch_length - (float) the distance between the branch end and the split base
        s_index - (int) The index of the last vertex that is part of a seam
        seams - (list of (int, int)) The seams of the tree
        jonc_seams - (list of (int, int)) The seams of the split
        random_angle - (float) The amount of possible deviation between directions and the actual split direction
        branch_rotation - (float) The rotation of the split around directions

    Returns:
        i1 - ((int, int, int, int, int, int, int, int)) The indexes of the first end of the split
        i2 - ((int, int, int, int, int, int, int, int)) The indexes of the second end of the split
        d1 - (Vector) The direction of the first end of the split
        d2 - (Vector) The direction of the second end of the split
        r1 - (float) The radius of the first end of the split
        r2 - (float) The radius of the second end of the split
        i1[0] - (int) The index of the last vertex that is part of a seam on the first end of the split
        i2[0] - (int) The index of the last vertex that is part of a seam on the second end of the split
    """
    random1 = random_angle * (random() - 0.5)
    random2 = random_angle * (random() - 0.5)
    random3 = random_angle * (random() - 0.5)

    rand_x = Matrix.Rotation(random1, 4, 'X')
    rand_y = Matrix.Rotation(random2, 4, 'Y')
    rand_z = Matrix.Rotation(random3, 4, 'Z')

    directions = (((directions * rand_x) * rand_y) * rand_z)
    barycentre = Vector((0, 0, 0))
    for i in indexes:
        barycentre += verts[i]
    barycentre /= len(indexes)

    directions.normalize()
    barycentre += directions * branch_length
    r1 = (object_verts[i1[0]] - object_verts[i1[4]]).length / 2
    r2 = (object_verts[i2[0]] - object_verts[i2[4]]).length / 2
    v = rot_scale(object_verts, scale, directions, radians(branch_rotation))
    d2 = v[-1]
    d1 = v[-2]

    n = len(verts)
    nentree = [n + i for i in entree]
    add_seams(nentree, seams)
    seams += [add_tuple(f, n) for f in jonc_seams]
    faces += [add_tuple(f, n) for f in object_faces]
    verts += [barycentre + i for i in v]
    joindre(verts, faces, indexes, nentree)

    i1 = [n + i for i in i1]
    i2 = [n + i for i in i2]
    add_seams(i1, seams)
    add_seams(i2, seams)

    dist = 1000
    ns_index = 0
    for i in nentree:
        length = (verts[s_index] - verts[i]).length
        if length < dist:
            dist = length
            ns_index = i
    seams.append((s_index, ns_index))
    return i1, i2, d1, d2, r1, r2, i1[0], i2[0]  # no need to return i1[0] and i2[0]...just do that outside of the func


def join_branch(verts, faces, indexes, scale, branch_length, branch_verts, direction, rand, s_index, seams):
    """ The goal is to add a Module to the tree. To do that, there is the list of existing vertices, the list of existing faces, the list of vertices to add and the list of faces to add.
        To know where to add the Module, the indexes of eight vertices is given.

    Args:
        verts - (list of (Vector, Vector, Vector)) The existing vertices
        faces - (list of (int, int, int, int)) The existing faces
        indexes - ((int, int, int, int, int, int, int, int)) the indexes of the end of the branch on which the Module will be added
        scale - (float) the scale of which the Module must be
        branch_length - (float) the distance between the branch end and the Module base
        branch_verts - (list of (Vector, Vector, Vector)) The vertices to add
        direction - (Vector) The direction the Module will be pointing at
        rand - (float) The amount of possible deviation between direction and the actual Module direction
        s_index - (int) The index of the last vertex that is part of a seam
        seams - (list of (int, int)) The seams of the tree

    Returns:
        nentree - ((int, int, int, int, int, int, int, int)) The indexes of the end of the Module
        direction - (Vector) The direction of the end of the Module
        ns_index - (int) The index of the last vertex that is part of a seam on the end of the Module
    """
    barycentre = Vector((0, 0, 0))
    random1 = rand * (random() - 0.5)
    random2 = rand * (random() - 0.5)
    random3 = rand * (random() - 0.5)
    for i in indexes:
        barycentre += verts[i]
    barycentre /= len(indexes)

    direction.normalized()
    rand_x = Matrix.Rotation(random1, 4, 'X')
    rand_y = Matrix.Rotation(random2, 4, 'Y')
    rand_z = Matrix.Rotation(random3, 4, 'Z')

    direction = (((direction * rand_x) * rand_y) * rand_z)
    barycentre += direction * branch_length
    n = len(verts)
    v = rot_scale(branch_verts, scale, direction, ((random() + 27) / 28) * randint(0, 8) / 8 * 2 * pi)
    nentree = [n + i for i in range(8)]
    verts += [ve + barycentre for ve in v]
    joindre(verts, faces, indexes, nentree)

    ns_index = 0
    dist = 1000
    for i in nentree:
        length = (verts[s_index] - verts[i]).length
        if length < dist:
            dist = length
            ns_index = i
    seams.append((s_index, ns_index))

    return nentree, direction, ns_index


def gravity(direction, gravity_strength):
    """ Applies a down translation to a vector to simulate gravity

    Args:
        direction - (Vector) The Vector to apply gravity to
        gravity_strength - (float)

    Returns:
        (Vector) The vector direction translated downward
    """
    v = Vector((0, 0, -1))
    norm = direction.length
    factor = (direction.cross(v)).length / norm / 100 * gravity_strength
    return direction + v * factor


def add_tuple(t, x):
    """Adds a value x to each component of the tuple

    Args:
        t - (tupe)
        x - (int,float)

    Returns:
         tuple in the form (x + a, x + b, x + c,...) where t is in the form (a, b, c,...)"""
    return tuple([x + i for i in t])


def rot_scale(v_co, scale, directions, rot_z):
    """ Rotates and scales a set of vectors

    Args:
        v_co - (list of (float, float, float))  The coordinates of the vectors
        scale - (foat) The scalar by xhich each vector is multiplied
        directions - (tuple) A vector that would be collinear whith a former (0,0,1) vector after the rotation
        rot_z - (float) The rotation of the set of vector around directions

    Returns:
        A set of coordinates representing all vectors of v_co after rotation and scaling
    """

    (x, y, z) = directions
    directions = Vector((-x, -y, z))
    q = Vector((0, 0, 1)).rotation_difference(directions)
    mat_rot = q.to_matrix()
    mat_rot.resize_4x4()
    mc = Matrix.Rotation(rot_z, 4, 'Z')
    v_co = [((v * scale) * mc) * mat_rot for v in v_co]
    return v_co


def fix_normals(inside):
    bpy.ops.object.mode_set(mode='EDIT')
    bpy.ops.mesh.select_all(action='SELECT')
    bpy.ops.mesh.normals_make_consistent(inside=inside)
    bpy.ops.mesh.select_all(action='DESELECT')
    bpy.ops.object.mode_set(mode='OBJECT')


def add_leaf(position, direction, rotation, scale):
    scene = bpy.context.scene

    verts, faces = ([(-1.0, 0.07, 0.05), (1.0, 0.07, 0.05), (-1.0, -1.01, 1.75),
                     (1.0, -1.01, 1.75), (-1.0, -0.76, 1.1), (-1.0, -0.38, 0.55),
                     (1.0, -0.38, 0.55), (1.0, -0.76, 1.1), (-0.33, 0.0, 0.0),
                     (0.33, 0.0, 0.0), (0.33, -1.16, 1.64), (-0.33, -1.16, 1.64),
                     (0.33, -0.56, 0.42), (-0.33, -0.56, 0.42), (0.33, -0.9, 1.0), (-0.33, -0.9, 1.0)],

                    [(14, 7, 3, 10), (9, 1, 6, 12), (12, 6, 7, 14), (5, 13, 15, 4), (13, 12, 14, 15),
                     (0, 8, 13, 5), (8, 9, 12, 13), (4, 15, 11, 2), (15, 14, 10, 11)])

    verts = [Vector(v) for v in verts]
    verts = rot_scale(verts, scale, direction, rotation)
    verts = [v + position for v in verts]

    mesh = bpy.data.meshes.new("leaf")
    mesh.from_pydata(verts, [], faces)
    mesh.update(calc_edges=False)

    obj = bpy.data.objects.new("leaf", mesh)
    obj.location = scene.cursor_location

    scene.objects.link(obj)
    scene.objects.active = obj

    obj.select = True
    bpy.ops.object.mode_set(mode='EDIT')
    bpy.ops.uv.unwrap(method='ANGLE_BASED', margin=0.001)
    bpy.ops.object.mode_set(mode='OBJECT')
    bpy.ops.object.shade_smooth()

def rehash_set(s, p_dist):
    new_set = []
    new_set.append(s[0])
    i = 1
    while i < len(s):
        n_dist = (s[i] - new_set[-1]).length
        if n_dist >= p_dist:
            new_set.append(new_set[-1] + p_dist/n_dist * (s[i] - new_set[-1]))
        else:
            i+=1
    return new_set



def smooth_stroke(iterations,smooth,points):
    
    for i in range(iterations):
        new_points = []
        new_points.append(points[0])
        for j in range (1,len(points)-1):
            new_points.append(smooth/2*(points[j-1]+points[j+1]) + (1-smooth)* points[j])
        new_points.append(points[-1])
        points = new_points
    return points
    
def create_tree(position, is_twig=False):
    """Creates a tree

    Details:
        There is a list of vertices, a list of faces and a list of seams.
        There is a list of all current end of the tree. At each iteration all those ends can evolve in three diferent ways:
            -The end can continue to grow as a branch, with a new end
            -The end can be splited in two branches, with a new end each
            -The end can break
        Depending on this choice, vertices and faces of a Module, Split or end cap will be added to the vertices and faces list.
        This processus is executed for both roots and branches generation.
        After this, the tree object itself is created, the vertices, faces and seams are applied.
        Once the object is created, it can be unwrapped, a material is asigned or created, and an armature is created.


    Args:
        position - (Vector) Position to generate tree at
        is_twig - (Bool) Is the tree a twig
    """
    scene = bpy.context.scene
    mtree_props = scene.mtree_props

    clock = Clock("create_tree")
    if not mtree_props.uv:
        mtree_props.finish_unwrap = False
    if mtree_props.unwrap_end_iteration >= mtree_props.iteration:
        mtree_props.unwrap_end_iteration = mtree_props.iteration - 1

    twig_leafs = []

    leafs_weight_indexes = []

    # deselecting all objects
    for select_ob in bpy.context.selected_objects:
        select_ob.select = False

    make_roots = mtree_props.create_roots
    trunk2 = mtree_props.preserve_trunk
    radius = mtree_props.radius

    # the list of bones is a list of...
    # [(string : parent name, string : bone name, Vector : tail position, Vector : head position), ...]
    bones = []
    leafs_start_index = 0
    unwrap_stop_index = 0
    big_j = S1
    seams2 = [s for s in R1.Seams]
    entree = [i for i in big_j.entree]

    last_bone = (1, Vector((0, 0, 1)))

    # Roots generation
    if not make_roots:
        verts = [Vector(v) * radius for v in root.verts]
        faces = [f for f in root.faces]
        extr = [i for i in root.sortie[1]]
    else:
        print("Generating Roots...")
        verts = [Vector(v) * radius for v in R1.verts]
        faces = [f for f in R1.faces]
        extr = [i for i in R1.stem]
        roots = [(i[2], i[1], i[0], i[2][0]) for i in R1.roots]
        roots_variations = 0.5
        roots_length = 1.4
        roots_rad_dec = 0.7

        for i in range(mtree_props.roots_iteration):
            next_roots = []
            for E in roots:
                indexes, radius, direction, s_index = E

                big_j = Joncts[1]
                i1 = [i for i in big_j.sortie[0]]
                i2 = [i for i in big_j.sortie[1]]
                jonct_seams = [s for s in big_j.Seams]
                inter_fact = (i / (1.4 * max(1, i))) ** 3 * random()
                jonct_verts = interpolate(big_j.verts1, big_j.verts2, inter_fact)
                barycentre = Vector((0, 0, 0))

                for k in indexes:
                    barycentre += verts[k]
                barycentre /= len(indexes)

                if i > 2:
                    direction += 0.7 * Vector((0, 0, -1)) / (max(1, 20 * abs(barycentre.z)))
                ni1, ni2, dir1, dir2, r1, r2, nsi1, nsi2 = join(verts, faces, indexes, jonct_verts, big_j.faces,
                                                                radius * roots_rad_dec, i1, i2, entree, direction,
                                                                roots_length, s_index, seams2, jonct_seams,
                                                                roots_variations,
                                                                ((random() + 27) / 28) * randint(0, 8) / 8 * 2 * pi)
                dir1 = gravity(dir1, -2)
                dir2 = gravity(dir2, -2)
                next_roots.append((ni1, radius * roots_rad_dec * r1, dir1, nsi1))
                next_roots.append((ni2, radius * roots_rad_dec * r2, dir2, nsi2))
            roots = next_roots

    radius = mtree_props.radius
    extremites = [(extr, radius, Vector((0, 0, 1)), extr[0], last_bone, trunk2, 0)]
    curr_grease_point = 0
    using_grease = False
    gp = bpy.context.scene.grease_pencil
    grease_points = []
    save_trunk_length = mtree_props.trunk_length
    save_trunk_space = mtree_props.trunk_space
    if mtree_props.use_grease_pencil and gp is not None and gp.layers.active is not None and gp.layers.active.active_frame is not None and len(gp.layers.active.active_frame.strokes) > 0 and len(gp.layers.active.active_frame.strokes[0].points) > 2:
        grease_points = rehash_set([i.co for i in gp.layers.active.active_frame.strokes[0].points], mtree_props.stroke_step_size)
        grease_points = smooth_stroke(5,mtree_props.smooth_stroke,grease_points)
        mtree_props.trunk_length = len(grease_points) -2
        using_grease = True
    
    # branches generation
    print("Generating Branches...")
    for i in range(mtree_props.iteration + mtree_props.trunk_length):

        if i == mtree_props.unwrap_end_iteration + mtree_props.trunk_length:
            unwrap_stop_index = len(verts)

        nextremites = []

        for E in extremites:
            indexes, radius, direction, s_index, Lb, trunk2, curr_rotation = E
            real_radius = (verts[indexes[0]] - verts[indexes[3]]).length
            new_rotation = (curr_rotation + mtree_props.branch_rotate + 2 * (1 - random()) * mtree_props.branch_random_rotate) % 360

            if i > mtree_props.preserve_end:
                trunk2 = False
            pos = position

            for k in indexes:
                pos += verts[k]
            pos /= len(indexes)
            direction.normalize()
            end = pos + direction * 10

            point_forces = [ob for ob in bpy.data.objects if ob.type == 'EMPTY' and ob.field.type == 'FORCE']
            wind_forces = [ob for ob in bpy.data.objects if ob.type == 'EMPTY' and ob.field.type == 'WIND']
            factor = mtree_props.fields_radius_factor
            point_net_force = Vector((0,0,0))
            for ob in point_forces:
                force_power = max(1,ob.field.falloff_power)
                sgn = 1 if ob.field.strength == 0 else ob.field.strength/abs(ob.field.strength)
                force_direction = pos - ob.location
                dist = force_direction.length
                force_direction.normalize()
                point_net_force += min((1/real_radius*factor + (1-factor))*abs(ob.field.strength)/((dist)**(force_power)), mtree_props.fields_strength_limit)*sgn*(force_direction)

            wind_net_force = Vector((0,0,0))
            for ob in wind_forces:
                force_direction = Vector((0,0,1))
                force_direction.rotate(ob.rotation_euler)
                wind_net_force += min(ob.field.strength,mtree_props.fields_strength_limit)*force_direction


            direction +=  mtree_props.fields_point_strength/10 * point_net_force + mtree_props.fields_wind_strength/30 * wind_net_force

            if bpy.data.objects.get(mtree_props.obstacle) is not None:
                obs = scene.objects[mtree_props.obstacle]
                scene.update()

                result, hit_pos, face_normal, face_index = obs.ray_cast(pos, end)
                if result:
                    force = abs(min(direction.dot(face_normal), 0)) * mtree_props.obstacle_strength / (
                        (hit_pos - pos).length + 1) * 2
                    direction += face_normal * force

            split_probability = mtree_props.trunk_split_proba if trunk2 else mtree_props.split_proba

            if i <= mtree_props.trunk_length:
                branch_verts = [v for v in branch.verts]
                if not using_grease:
                    ni, direction, nsi = join_branch(verts, faces, indexes, radius, mtree_props.trunk_space, branch_verts,
                                                     direction,
                                                     mtree_props.trunk_variation, s_index, seams2)
                    sortie = pos + direction * mtree_props.branch_length

                else:
                    grease_dir = grease_points[curr_grease_point+1] - grease_points[curr_grease_point]
                    grease_length = grease_dir.length
                    grease_dir.normalize()
                    ni, direction, nsi = join_branch(verts, faces, indexes, radius,grease_length,
                                                     branch_verts,
                                                     grease_dir,
                                                     0, s_index, seams2)
                    sortie = pos + grease_dir * grease_length
                    curr_grease_point +=1

                if i <= mtree_props.bones_iterations:
                    bones.append((Lb[0], len(bones) + 2, Lb[1], sortie))

                nb = (len(bones) + 1, sortie)
                nextremites.append((ni, radius * 0.98, direction, nsi, nb, trunk2, curr_rotation))

            elif i == mtree_props.iteration + mtree_props.trunk_length - 1 or random() < mtree_props.break_chance or (verts[indexes[0]] - verts[indexes[3]]).length < mtree_props.branch_min_radius:
                end_verts = [Vector(v) for v in end_cap.verts]
                end_faces = [f for f in end_cap.faces]
                if is_twig:
                    twig_leafs.append((pos, direction, curr_rotation))
                n = len(verts)
                join_branch(verts, faces, indexes, radius, mtree_props.trunk_space, end_verts, direction,
                            mtree_props.trunk_variation, s_index, seams2)

                faces += [add_tuple(f, n) for f in end_faces]
                end_seams = [(1, 0), (2, 1), (3, 2), (4, 3), (5, 4), (6, 5), (7, 6), (0, 7)]
                seams2 += [add_tuple(f, n) for f in end_seams]
                leafs_weight_indexes.append(len(verts)-1)

            elif i < mtree_props.iteration + mtree_props.trunk_length - 1 and i == mtree_props.trunk_length + 1 or random() < split_probability:
                variation = mtree_props.trunk_variation if trunk2 else mtree_props.randomangle
                rand_j = randint(1,5)
                rand_T = randint(0,4)
                big_j = Joncts[rand_j] if (not trunk2) else Trunks[rand_T]
                i1 = [i for i in big_j.sortie[0]]
                i2 = [i for i in big_j.sortie[1]]
                jonct_seams = [s for s in big_j.Seams]

                inter_fact = mtree_props.trunk_split_angle if trunk2 else mtree_props.split_angle
                jonct_verts = interpolate(big_j.verts1, big_j.verts2, inter_fact)
                length = mtree_props.trunk_space if trunk2 else mtree_props.branch_length
                ni1, ni2, dir1, dir2, r1, r2, nsi1, nsi2 = join(verts, faces, indexes, jonct_verts, big_j.faces,
                                                                radius * (1 + mtree_props.radius_dec) / 2, i1, i2, entree,
                                                                direction, length, s_index, seams2, jonct_seams,
                                                                variation, new_rotation)
                sortie1 = (verts[ni1[0]] + verts[ni1[4]]) / 2
                sortie2 = (verts[ni2[0]] + verts[ni2[4]]) / 2
                nb = len(bones)

                if i <= mtree_props.bones_iterations:
                    bones.append((Lb[0], nb + 2, Lb[1], sortie1))
                    bones.append((Lb[0], nb + 3, Lb[1], sortie2))

                nb1 = (nb + 2, sortie1)
                nb2 = (nb + 3, sortie2)
                if mtree_props.gravity_start <= i <= mtree_props.gravity_end:
                    dir1 = gravity(dir1, mtree_props.gravity_strength)
                    dir2 = gravity(dir2, mtree_props.gravity_strength)

                nextremites.append((ni1, radius * mtree_props.radius_dec * r1, dir1, nsi1, nb1, trunk2, new_rotation))
                nextremites.append((ni2, radius * mtree_props.radius_dec * r2, dir2, nsi2, nb2, False, new_rotation))

            else:
                branch_verts = [v for v in branch.verts]

                variation = mtree_props.trunk_variation if trunk2 else mtree_props.randomangle
                length = mtree_props.trunk_space if trunk2 else mtree_props.branch_length
                ni, direction, nsi = join_branch(verts, faces, indexes, radius, length, branch_verts, direction,
                                                 variation, s_index, seams2)
                if is_twig:
                    twig_leafs.append((pos + direction * length * random(), direction, curr_rotation))
                sortie = pos + direction * mtree_props.branch_length

                if i <= mtree_props.bones_iterations:
                    bones.append((Lb[0], len(bones) + 2, Lb[1], sortie))

                nb = (len(bones) + 1, sortie)
                if mtree_props.gravity_start <= i <= mtree_props.gravity_end:
                    direction = gravity(direction, mtree_props.gravity_strength)
                nextremites.append((ni, radius * mtree_props.radius_dec, direction, nsi, nb, trunk2, curr_rotation))

        extremites = nextremites
    # mesh and object creation
    mtree_props.trunk_length = save_trunk_length
    mtree_props.trunk_space = save_trunk_space
    print("Building Object...")

    mesh = bpy.data.meshes.new("tree")

    mesh.from_pydata(verts, [], faces)
    mesh.update(calc_edges=False)
    obj = bpy.data.objects.new("tree", mesh)
    obj.location = position if not using_grease else grease_points[0] - Vector((0,0,1))
    scene.objects.link(obj)
    scene.objects.active = obj
    obj.select = True
    bpy.ops.object.shade_smooth()
    bpy.ops.object.mode_set(mode='EDIT')

    obj.select = False

    vgroups = obj.vertex_groups
   # add vertex group for the leaves particle system
    leaves_group = obj.vertex_groups.new("leaf")
    vgroups.active_index = vgroups["leaf"].index
    bpy.ops.object.mode_set(mode='EDIT')
    bpy.ops.mesh.select_all(action='DESELECT')
    bpy.ops.object.mode_set(mode='OBJECT')
    for i in leafs_weight_indexes:
        mesh.vertices[i].select = True

    bpy.ops.object.mode_set(mode='EDIT')
    for i in range(mtree_props.leafs_iteration_length+5):
        bpy.ops.mesh.select_more()

    bpy.ops.object.vertex_group_assign()
    bpy.ops.mesh.select_all(action='SELECT')
    bpy.ops.object.mode_set(mode='WEIGHT_PAINT')
    bpy.context.object.data.use_paint_mask_vertex = True
    bpy.ops.object.vertex_group_smooth(factor=1, repeat=3)
    bpy.ops.object.mode_set(mode='EDIT')
    bpy.ops.mesh.remove_doubles()
    bpy.ops.object.mode_set(mode='OBJECT')

    # add vertex group for the wind animations
    wind_group = obj.vertex_groups.new("wind_anim")

    # fix normals, then make sure they are fixed :)
    print("Setting Normals...")
    fix_normals(inside=False)
    if obj.data.polygons[0].normal.x < 0:
        fix_normals(inside=True)

    # particle setup
    if mtree_props.particle:
        print("Configuring Particle System...")
        create_system(obj, mtree_props.number, mtree_props.display, vgroups["leaf"])

    # uv unwrapping
    if mtree_props.uv:
        print("Unwrapping...")
        clock.add_sub_job("uv")
        test = [[False, []] for _ in range(len(verts))]
        for (a, b) in seams2:
            a, b = min(a, b), max(a, b)
            test[a][0] = True
            test[b][0] = True
            test[a][1].append(b)
            test[b][1].append(a)

        for edge in mesh.edges:
            v0, v1 = edge.vertices[0], edge.vertices[1]
            if test[v0][0] and v1 in test[v0][1]:
                edge.select = True

        bpy.ops.object.mode_set(mode='EDIT')
        bpy.ops.mesh.mark_seam(clear=False)
        bpy.ops.mesh.select_all(action='DESELECT')
        bpy.ops.object.mode_set(mode='OBJECT')

        mesh.vertex_colors.new()
        color_map = mesh.vertex_colors.active
        for i in range(unwrap_stop_index):
            color_map.data[i].color = (0, 0, 0)
            mesh.vertices[i].select = True
        bpy.ops.object.mode_set(mode='EDIT')
        if mtree_props.finish_unwrap:
            bpy.context.tool_settings.mesh_select_mode = (True, False, False)
            bpy.ops.uv.unwrap(method='ANGLE_BASED', margin=0.001)
            rotate()  # this will set the mode to object already
        else:
            bpy.ops.object.mode_set(mode='OBJECT')
        bpy.ops.object.mode_set(mode='VERTEX_PAINT')
        bpy.ops.paint.vertex_color_smooth()
        bpy.ops.object.mode_set(mode='OBJECT')
        clock.stop("uv")

    # material creation
    print("Setting Materials...")
    if mtree_props.mat:
        obj.active_material = build_bark_material("bark")

    elif bpy.data.materials.get(mtree_props.bark_material) is not None:
        obj.active_material = bpy.data.materials.get(mtree_props.bark_material)

    # armature creation
    if mtree_props.create_armature:
        print("Building Armature...")
        clock.add_sub_job("armature")
        bpy.ops.object.add(type='ARMATURE', enter_editmode=True, location=Vector((0, 0, 0)))
        arm = bpy.context.object
        arm.show_x_ray = True
        amt = arm.data
        arm.data.draw_type = 'STICK'
        bone = amt.edit_bones.new('1')
        bone.head = Vector((0, 0, 0))
        bone.tail = Vector((0, 0, 1))

        for (pname, name, h, t) in bones:
            bone = amt.edit_bones.new(str(name))
            bone.parent = arm.data.edit_bones[str(pname)]
            bone.use_connect = True
            bone.head = h
            bone.tail = t

        bpy.ops.object.editmode_toggle()
        bpy.ops.object.select_all(action='DESELECT')
        obj.select = True
        arm.select = True
        scene.objects.active = arm
        bpy.ops.object.parent_set(type='ARMATURE_AUTO')
        bpy.ops.object.select_all(action='DESELECT')
        clock.stop("armature")

    if mtree_props.visualize_leafs:
        clock.add_sub_job("vis leaves")
        scene.objects.active = obj
        vgroups.active_index = vgroups["leaf"].index
        bpy.ops.paint.weight_paint_toggle()
        clock.stop("vis leaves")

    obj.select = True
    scene.objects.active = obj
    obj["is_tree"] = True
    obj["has_armature"] = True if mtree_props.create_armature else False

    clock.stop("create_tree")
    print("\nDeveloper Info:")
    clock.display()
    if is_twig:
        return twig_leafs